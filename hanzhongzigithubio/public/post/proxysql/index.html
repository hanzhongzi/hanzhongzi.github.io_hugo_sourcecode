



<!DOCTYPE html>
<html lang="en">

<head>
<title>ProxySQL ä¸€ç¯‡æ–‡ç« æå®š</title>
<meta name="viewport"content="width=device-width, user-scalable=no, initial-scale=1.0, shrink-to-fit=no, viewport-fit=cover">

<meta name="description" content="ProxySQL é€Ÿé€š">

<meta itemprop="name" content="ProxySQL ä¸€ç¯‡æ–‡ç« æå®š">
<meta itemprop="description" content="ProxySQL é€Ÿé€š">
<meta itemprop="image" content="https://hanzhongzi.github.io/img/author.jpg">


<meta name="twitter:description" content="ProxySQL é€Ÿé€š" />


<link rel="alternate" href="https://hanzhongzi.github.io/feed.xml" title="ç€šä¸­å­çš„ä¸ªäººç½‘ç«™" type="application/rss+xml"/>

<link rel="shortcut icon" href="https://hanzhongzi.github.io/imgs/icons/favicon.ico"/>
<link rel="apple-touch-icon" href="https://hanzhongzi.github.io/imgs/icons/apple-touch-icon.png" />
<link rel="apple-touch-icon-precomposed" href="https://hanzhongzi.github.io/imgs/icons/apple-touch-icon.png" />




<style>
    @font-face {
        font-family: 'Xc Font';
        font-weight: 400;
        font-style: normal;
        font-display: swap;
        src: url('https://cdn.jsdelivr.net/gh/Xpblog666/cdn@1.0/HarmonyOS_Sans_SC_Medium.ttf');
        src: url('https://cdn.jsdelivr.net/gh/Xpblog666/cdn@1.0/HarmonyOS_Sans_SC_Medium.ttf') format('truetype');
    }

    html {
        font-family: 'Xc Font', 'PingFang SC', 'Noto Serif SC', 'HarmonyOS_Sans_SC_Medium', 'Fira Mono', 'Microsoft YaHei', Arial, sans-serif
    }

    html .Qc_header_above .Qc_container {
        max-width: 1720px
    }

    html .Qc_header_below .Qc_container {
        max-width: 1720px
    }

    html .Qc_header_searchout .Qc_container {
        max-width: 1720px
    }

    html .Qc_main {
        max-width: 980px
    }

    html .Qc_aside {
        width: 260px
    }

    body::before {
        background: #f0f0f0;
        background: ;
        background-position: center 0;
        background-repeat: no-repeat;
        background-size: cover;
    }
</style>


<link rel="stylesheet" href="https://hanzhongzi.github.io/css/global.min.css" />
<link rel="stylesheet" href="https://hanzhongzi.github.io/css/style.css" />
<link rel="stylesheet" href="https://hanzhongzi.github.io/css/theme.min.css" />

<link rel="stylesheet" href="https://hanzhongzi.github.io/css/font-awesome.min.css" />


<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css" />



<script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
  
    init({
      el: '.waline-container',
      placeholder: "è¯·ä¸è¦åå•¬æ‚¨çš„è¯„è®º ãƒ¾(â‰§â–½â‰¦*)o",
      sofa: "ç§ï¼Œè¿™é‡Œæ²¡äººï¼Œè¿˜ä¸æŠ¢å ç¬¬ä¸€çš„ä½ç½® (â‰§âˆ€â‰¦)ã‚",
      pageview: true, 
      comment: true, 
      emoji: [
        '//unpkg.com/@waline/emojis@1.1.0/weibo',
        '//unpkg.com/@waline/emojis@1.1.0/bilibili',
      ],
      login: 'disable',
      imgUploader: false,
      wordLimit: 200,
      requiredMeta: ['nick', 'mail'],
      reaction: true,
      reactionText: [ 'ç‚¹èµ', 'è¸©ä¸€ä¸‹', 'å¾—æ„', 'ä¸å±‘', 'å°´å°¬', 'ç¡è§‰'],
      reactionTitle: "æ‚¨è®¤ä¸ºè¿™ç¯‡æ–‡ç« æ€ä¹ˆæ ·ï¼Ÿ",
      dark: 'auto', 
      serverURL: "app-production-dfd0.up.railway.app",
    });
  </script>
  









 
 


  
  









    
    







                
 
    

























</head>

<body>
	<header class="Qc_header  active Qc_slid">
<div class="Qc_header_above">
    <div class="Qc_container"> 
        <svg class="Qc_header_above-slideicon" viewBox="0 0 1152 1024"
            xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path
                d="M76.032 872a59.968 59.968 0 1 0 0 120h999.936a59.968 59.968 0 1 0 0-120H76.032zm16-420.032a59.968 59.968 0 1 0 0 120h599.936a59.968 59.968 0 1 0 0-119.936H92.032zM76.032 32a59.968 59.968 0 1 0 0 120h999.936a60.032 60.032 0 0 0 0-120H76.032z" />
        </svg> 
        <a class="Qc_header_above-logo" href="/" title="John'Blog"> 
            <img class="Qc_logo"
                src="/static/front/images/qiu-logo.png" /></a>
        <nav class="Qc_header_above_nav"> 
            
            <a class="item " href="/" title="é¦–é¡µ" style="margin-right:8px">
                <i class="fa fa-home"></i> é¦–é¡µ
            </a>
           
            <a class="item " href="/flinks" title="å‹æƒ…é“¾æ¥">
                <i class="fa fa-link"></i>å‹æƒ…é“¾æ¥
            </a> 


            <a class="item " href="/about" title="å…³äºæˆ‘">
                <i class="fa fa-user"></i>å…³äºæœ¬ç«™
            </a>
        </nav> 

        
        
        <svg class="Qc_header_above-searchicon" viewBox="0 0 1024 1024"
            xmlns="http://www.w3.org/2000/svg" width="20" height="20" style="display: block;">
            <path
                d="M1008.19 932.031L771.72 695.56a431.153 431.153 0 1 0-76.158 76.158l236.408 236.472a53.758 53.758 0 0 0 76.158 0 53.758 53.758 0 0 0 0-76.158zM107.807 431.185a323.637 323.637 0 0 1 323.316-323.381 323.7 323.7 0 0 1 323.381 323.38 323.637 323.637 0 0 1-323.38 323.317 323.637 323.637 0 0 1-323.317-323.316z" />
        </svg> 
        <a href="javascript:void(0)" type="button" id="ClickMe" style="margin: 0px 3px 2px 13px"><svg
                t="1675873194952" class="loingico" viewBox="0 0 1024 1024" version="1.1"
                xmlns="http://www.w3.org/2000/svg" p-id="3929" width="22" height="22">
                <path
                    d="M554.666667 349.44a48.213333 48.213333 0 1 1-47.786667 47.786667A48.213333 48.213333 0 0 1 554.666667 349.44m0-85.333333a133.546667 133.546667 0 1 0 133.546666 133.12A133.12 133.12 0 0 0 554.666667 264.106667z"
                    fill="var(--routine)" p-id="3930"></path>
                <path
                    d="M768 759.893333a42.666667 42.666667 0 0 1-42.666667-42.666666 170.666667 170.666667 0 0 0-341.333333 0 42.666667 42.666667 0 0 1-85.333333 0 256 256 0 0 1 512 0 42.666667 42.666667 0 0 1-42.666667 42.666666z"
                    fill="var(--routine)" p-id="3931"></path>
                <path
                    d="M554.666667 213.333333a341.333333 341.333333 0 1 1-341.333334 341.333334 341.333333 341.333333 0 0 1 341.333334-341.333334m0-85.333333a426.666667 426.666667 0 1 0 426.666666 426.666667A426.666667 426.666667 0 0 0 554.666667 128z"
                    fill="var(--routine)" p-id="3932"></path>
            </svg> </a>
       
    </div>
</div>

<div class="Qc_header_slideout"> 
    <img width="100%" height="150" class="Qc_header_slideout-image"
        src="https://qiucode.cn/shaonv.jpg" alt="ä¾§è¾¹æ å£çº¸" />
    <div class="Qc_header_slideout-author"> <img width="50" height="50" class="avatar"
            src="https://thirdqq.qlogo.cn/g?b=qq&nk=687778&s=100" alt="åšä¸»æ˜µç§°" />
        <div class="info"> <a class="link" href="https://qiucode.cn" target="_blank"
                rel="noopener noreferrer nofollow">John</a>
            <p class="motto Qc_motto"></p>
        </div>
    </div>
    <ul class="Qc_header_slideout-count"> </ul>
    <ul class="Qc_header_slideout-menu panel-box">
        <li> <a class="link" href="https://qiucode.cn/" title="é¦–é¡µ"> <span><i class="iconfont icon-A131"></i>
                    é¦–é¡µ</span> </a> </li>
        <li> <a class="link panel" href="#" rel="nofollow"> <span><i class="iconfont icon-A129"></i> åˆ†ç±»</span>
                <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="13"
                    height="13">
                    <path
                        d="M624.865 512.247L332.71 220.088c-12.28-12.27-12.28-32.186 0-44.457 12.27-12.28 32.186-12.28 44.457 0l314.388 314.388c12.28 12.27 12.28 32.186 0 44.457L377.167 848.863c-6.136 6.14-14.183 9.211-22.228 9.211s-16.092-3.071-22.228-9.211c-12.28-12.27-12.28-32.186 0-44.457l292.155-292.16z" />
                </svg> </a>
            <ul class="slides panel-body panel-box">
                <li>
                    <div class="link panel "> <a href="https://qiucode.cn/category/default/" title="æ—¥å¸¸åˆ†äº«">æ—¥å¸¸åˆ†äº«</a>
                        <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="13"
                            height="13">
                            <path
                                d="M624.865 512.247L332.71 220.088c-12.28-12.27-12.28-32.186 0-44.457 12.27-12.28 32.186-12.28 44.457 0l314.388 314.388c12.28 12.27 12.28 32.186 0 44.457L377.167 848.863c-6.136 6.14-14.183 9.211-22.228 9.211s-16.092-3.071-22.228-9.211c-12.28-12.27-12.28-32.186 0-44.457l292.155-292.16z" />
                        </svg> </div>
                    <ul class="slides panel-body">
                        <li><a class="link " href="https://qiucode.cn/category/wmfx/" title="å¤–è´¸åˆ†äº«">å¤–è´¸åˆ†äº«</a></li>
                        <li><a class="link " href="https://qiucode.cn/category/wztj/" title="ç½‘ç«™æ¨è">ç½‘ç«™æ¨è</a></li>
                        <li><a class="link " href="https://qiucode.cn/category/yxxg/" title="æ¸¸æˆç›¸å…³">æ¸¸æˆç›¸å…³</a></li>
                    </ul>
                </li>
                <li><a class="link " href="https://qiucode.cn/category/xitong/" title="ç³»ç»Ÿç›¸å…³">ç³»ç»Ÿç›¸å…³</a></li>
                <li>
                    <div class="link panel "> <a href="https://qiucode.cn/category/wangzhan/"
                            title="ç½‘ç«™æ–‡æ¡£">ç½‘ç«™æ–‡æ¡£</a> <svg class="icon" viewBox="0 0 1024 1024"
                            xmlns="http://www.w3.org/2000/svg" width="13" height="13">
                            <path
                                d="M624.865 512.247L332.71 220.088c-12.28-12.27-12.28-32.186 0-44.457 12.27-12.28 32.186-12.28 44.457 0l314.388 314.388c12.28 12.27 12.28 32.186 0 44.457L377.167 848.863c-6.136 6.14-14.183 9.211-22.228 9.211s-16.092-3.071-22.228-9.211c-12.28-12.27-12.28-32.186 0-44.457l292.155-292.16z" />
                        </svg> </div>
                    <ul class="slides panel-body">
                        <li><a class="link " href="https://qiucode.cn/category/bkfx/" title="åšå®¢åˆ†äº«">åšå®¢åˆ†äº«</a></li>
                        <li><a class="link " href="https://qiucode.cn/category/wzym/" title="ç½‘ç«™æºç ">ç½‘ç«™æºç </a></li>
                    </ul>
                </li>
                <li>
                    <div class="link panel "> <a href="https://qiucode.cn/category/ruanjian/"
                            title="è½¯ä»¶åˆ†äº«">è½¯ä»¶åˆ†äº«</a> <svg class="icon" viewBox="0 0 1024 1024"
                            xmlns="http://www.w3.org/2000/svg" width="13" height="13">
                            <path
                                d="M624.865 512.247L332.71 220.088c-12.28-12.27-12.28-32.186 0-44.457 12.27-12.28 32.186-12.28 44.457 0l314.388 314.388c12.28 12.27 12.28 32.186 0 44.457L377.167 848.863c-6.136 6.14-14.183 9.211-22.228 9.211s-16.092-3.071-22.228-9.211c-12.28-12.27-12.28-32.186 0-44.457l292.155-292.16z" />
                        </svg> </div>
                    <ul class="slides panel-body">
                        <li><a class="link " href="https://qiucode.cn/category/sjrj/" title="ğŸ“±æ‰‹æœºè½¯ä»¶">ğŸ“±æ‰‹æœºè½¯ä»¶</a>
                        </li>
                        <li><a class="link " href="https://qiucode.cn/category/dnrj/" title="ğŸ’»ç”µè„‘è½¯ä»¶">ğŸ’»ç”µè„‘è½¯ä»¶</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li> <a class="link panel" href="#" rel="nofollow"> <span><i class="iconfont icon-A3"></i> é¡µé¢</span>
                <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="13"
                    height="13">
                    <path
                        d="M624.865 512.247L332.71 220.088c-12.28-12.27-12.28-32.186 0-44.457 12.27-12.28 32.186-12.28 44.457 0l314.388 314.388c12.28 12.27 12.28 32.186 0 44.457L377.167 848.863c-6.136 6.14-14.183 9.211-22.228 9.211s-16.092-3.071-22.228-9.211c-12.28-12.27-12.28-32.186 0-44.457l292.155-292.16z" />
                </svg> </a>
            <ul class="slides panel-body">
                <li><a class="link " href="https://qiucode.cn/sn.html" title="æˆ‘çš„è®°å½•">æˆ‘çš„è®°å½•</a></li>
                <li><a class="link " href="https://qiucode.cn/youlian.html" title="å‹æƒ…é“¾æ¥">å‹æƒ…é“¾æ¥</a></li>
                <li><a class="link " href="https://qiucode.cn/site.html" title="ç«™ç‚¹ç»Ÿè®¡">ç«™ç‚¹ç»Ÿè®¡</a></li>
                <li><a class="link " href="https://qiucode.cn/Aboutme.html" title="å…³äºæˆ‘">å…³äºæˆ‘</a></li>
            </ul>
        </li>
    </ul>
    <ul class="Qc_header_slideout-menu panel-box" style="margin-top: 15px;margin-bottom: 100px;">
        <li> <a class="link panel" href="#" rel="nofollow"> <span><i class="iconfont icon-A17"></i> ç”¨æˆ·ç™»å½•</span>
                <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="13"
                    height="13">
                    <path
                        d="M624.865 512.247L332.71 220.088c-12.28-12.27-12.28-32.186 0-44.457 12.27-12.28 32.186-12.28 44.457 0l314.388 314.388c12.28 12.27 12.28 32.186 0 44.457L377.167 848.863c-6.136 6.14-14.183 9.211-22.228 9.211s-16.092-3.071-22.228-9.211c-12.28-12.27-12.28-32.186 0-44.457l292.155-292.16z">
                    </path>
                </svg> </a>
            <ul class="slides panel-body">
                <li> <a class="link" href="https://qiucode.cn/admin/login.php" target="_blank"
                        rel="noopener noreferrer nofollow">ç™»å½•</a> <a class="link"
                        href="https://qiucode.cn/admin/register.php" target="_blank"
                        rel="noopener noreferrer nofollow">æ³¨å†Œ</a> </li>
            </ul>
        </li>
    </ul>
</div>
<div class="Qc_header_mask"></div>

<script>

    let sideBtn = document.querySelector(".Qc_header_above .Qc_container .Qc_header_above-slideicon")

    sideBtn.addEventListener("click", () => {
        document.querySelector(".Qc_header_slideout").classList.add("active")
        document.querySelector(".Qc_header_mask").classList.add("active")
    })

    let maskBtn = document.querySelector(".Qc_header_mask")

    maskBtn.addEventListener("click",() => {
        document.querySelector(".Qc_header_slideout").classList.remove("active")
        maskBtn.classList.remove("active")
    })

   
    

</script></header>
	
	<div class="Qc_container showInUp">



<div class="Qc_main Qc_post">
    <div class="Qc_detail">
        <h1 class="title Qc_psot_title"> ProxySQL ä¸€ç¯‡æ–‡ç« æå®š</h1>
        <div class="Qc_detail_category"> </div>
        <article class="Qc_detail_article" id="article-container">
            <p>ProxySql.md</p>
<h1 id="proxysql">ProxySQL</h1>
<table>
<thead>
<tr>
<th>ç¼–å†™äºº</th>
<th>ç¼–å†™æ—¶é—´</th>
<th>ç¼–å†™è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç« ç€šä¸­</td>
<td>2020-9-12</td>
<td>æ¥ä¸Šä¸€ç¯‡<a href="http://wiki-private.capitalonline.net:8090/pages/viewpage.action?pageId=59474716">Mysql5.7ä¸»ä»æ­å»º</a>ä¸€èµ·è§‚çœ‹è¾ƒä½³</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>ç®€å•ä»‹ç»: ProxySQL æ˜¯åŸºäº MySQL çš„ä¸€æ¬¾å¼€æºçš„ä¸­é—´ä»¶çš„äº§å“ï¼Œæ˜¯ä¸€ä¸ªçµæ´»çš„ MySQL ä»£ç†å±‚ï¼Œå¯ä»¥å®ç°è¯»å†™åˆ†ç¦»ï¼Œæ”¯æŒ Query è·¯ç”±åŠŸèƒ½ï¼Œæ”¯æŒåŠ¨æ€æŒ‡å®šæŸä¸ª SQL è¿›è¡Œç¼“å­˜ï¼Œæ”¯æŒåŠ¨æ€åŠ è½½ï¼ˆæ— éœ€é‡å¯ ProxySQL æœåŠ¡ï¼‰ï¼Œæ•…éšœåˆ‡æ¢å’Œä¸€äº› SQL çš„è¿‡æ»¤åŠŸèƒ½ã€‚</p>
<p>githubåœ°å€ï¼šhttps://github.com/sysown/proxysql/releases</p>
<p>å®˜æ–¹æ–‡æ¡£: <a href="https://proxysql.com/documentation/">https://proxysql.com/documentation/</a></p>
<h2 id="ä¸‹è½½ä¸å®‰è£…">ä¸‹è½½ä¸å®‰è£…</h2>
<h3 id="ubuntu">Ubuntu</h3>
<blockquote>
<h4 id="ä¸‹è½½">ä¸‹è½½</h4>
<p><code>wget  https://github.com/sysown/proxysql/releases/download/v2.0.14/proxysql_2.0.14-dbg-ubuntu16_amd64.deb </code></p>
<h4 id="å®‰è£…">å®‰è£…</h4>
<p><code>dpkg -i proxysql_2.0.14-dbg-ubuntu16_amd64.deb</code></p>
</blockquote>
<h3 id="centos8">Centos8</h3>
<blockquote>
<h4 id="ä¸‹è½½-1">ä¸‹è½½</h4>
<p>wget <a href="https://github.com/sysown/proxysql/releases/download/v2.0.14/proxysql-2.0.14-1-dbg-centos8.x86_64.rpm">https://github.com/sysown/proxysql/releases/download/v2.0.14/proxysql-2.0.14-1-dbg-centos8.x86_64.rpm</a></p>
<h4 id="å®‰è£…-1">å®‰è£…</h4>
<p><code> yum -y install proxysql-2.0.14-1-centos8.x86_64.rpm</code></p>
</blockquote>
<p>centos7 : <a href="https://github.com/sysown/proxysql/releases/download/v2.0.14/proxysql-2.0.14-1-centos7.x86_64.rpm">https://github.com/sysown/proxysql/releases/download/v2.0.14/proxysql-2.0.14-1-centos7.x86_64.rpm</a></p>
<h2 id="å¯åŠ¨">å¯åŠ¨</h2>
<p>å¯åŠ¨ï¼š<code>systemctl restart proxysql</code></p>
<p>åœæ­¢:  <code>systemctl stop proxysql</code></p>
<p>é»˜è®¤ç›‘å¬ <code>6032</code> å’Œ <code>6033</code> ç«¯å£,<code>6032 </code>æ˜¯ ProxySQL çš„ç®¡ç†ç«¯å£å·ï¼Œ<code>6033</code>æ˜¯å¯¹å¤–æœåŠ¡çš„ç«¯å£å·
ProxySQL çš„ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯é»˜è®¤çš„ <code>admin</code>ã€‚</p>
<h2 id="ç™»å½•">ç™»å½•</h2>
<p>éœ€è¦æœ‰mysqlçš„å®¢æˆ·ç«¯</p>
<pre tabindex="0"><code>[root@localhost proxysql]# mysql -u admin -padmin -h 127.0.0.1 -P 6032 --prompt=&#39;ProxySQL-Admin&gt;  &#39;

ProxySQL-Admin&gt;  show databases;
+-----+---------------+-------------------------------------+
| seq | name          | file                                |
+-----+---------------+-------------------------------------+
| 0   | main          |  å†…å­˜é…ç½®æ•°æ®åº“ï¼Œå³ MEMORYï¼Œè¡¨é‡Œå­˜æ”¾åç«¯ db å®ä¾‹ã€ç”¨æˆ·éªŒè¯ã€è·¯ç”±è§„åˆ™ç­‰ä¿¡æ¯ã€‚   |
| 2   | disk          | /var/lib/proxysql/proxysql.db æŒä¹…åŒ–çš„ç£ç›˜çš„é…ç½®       |
| 3   | stats         |   ç»Ÿè®¡ä¿¡æ¯çš„æ±‡æ€»           |
| 4   | monitor       | ä¸€äº›ç›‘æ§çš„æ”¶é›†ä¿¡æ¯ï¼Œæ¯”å¦‚æ•°æ®åº“çš„å¥åº·çŠ¶æ€ç­‰  |
| 5   | stats_history | /var/lib/proxysql/proxysql_stats.dbè¿™ä¸ªåº“æ˜¯ ProxySQL æ”¶é›†çš„æœ‰å…³å…¶å†…éƒ¨åŠŸèƒ½çš„å†å²æŒ‡æ ‡ |
+-----+---------------+-------------------------------------+
5 rows in set (0.00 sec)
</code></pre><p>note: If your MySQL client version is version 8.04 or higher add <code>--default-auth=mysql_native_password</code> to the above command to connect to the admin interface.</p>
<p>è¿™é‡Œé¢æœ‰5ä¸ªæ•°æ®åº“</p>
<p>main: å†…å­˜é…ç½®æ•°æ®åº“ï¼Œå³ MEMORYï¼Œè¡¨é‡Œå­˜æ”¾åç«¯ db å®ä¾‹ã€ç”¨æˆ·éªŒè¯ã€è·¯ç”±è§„åˆ™ç­‰ä¿¡æ¯ã€‚</p>
<pre tabindex="0"><code>ProxySQL-Admin&gt;  use main
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
ProxySQL-Admin&gt;  show tables;
+----------------------------------------------------+
| tables                                             |
+----------------------------------------------------+
| global_variables                                   |
| mysql_aws_aurora_hostgroups                        |
| mysql_collations                                   |
| mysql_firewall_whitelist_rules                     |
| mysql_firewall_whitelist_sqli_fingerprints         |
| mysql_firewall_whitelist_users                     |
| mysql_galera_hostgroups                            |
| mysql_group_replication_hostgroups                 |
| mysql_query_rulesæŒ‡å®š Query è·¯ç”±åˆ°åç«¯ä¸åŒæœåŠ¡å™¨çš„è§„åˆ™åˆ—è¡¨|
| mysql_query_rules_fast_routing                     |
| mysql_replication_hostgroups é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯         |
| mysql_serversåç«¯å¯ä»¥è¿æ¥ MySQL æœåŠ¡å™¨çš„åˆ—è¡¨            |
| mysql_usersé…ç½®åç«¯æ•°æ®åº“çš„è´¦å·å’Œç›‘æ§çš„è´¦å·ã€‚             |
| proxysql_servers                                   |
| restapi_routes                                     |
| runtime_checksums_values                           |
| runtime_global_variables                           |
| runtime_mysql_aws_aurora_hostgroups                |
| runtime_mysql_firewall_whitelist_rules             |
| runtime_mysql_firewall_whitelist_sqli_fingerprints |
| runtime_mysql_firewall_whitelist_users             |
| runtime_mysql_galera_hostgroups                    |
| runtime_mysql_group_replication_hostgroups         |
| runtime_mysql_query_rules                          |
| runtime_mysql_query_rules_fast_routing             |
| runtime_mysql_replication_hostgroups               |
| runtime_mysql_servers                              |
| runtime_mysql_users                                |
| runtime_proxysql_servers                           |
| runtime_restapi_routes                             |
| runtime_scheduler                                  |
| scheduler                                          |
+----------------------------------------------------+
32 rows in set (0.00 sec)
</code></pre><p><strong>æ³¨æ„</strong>ï¼š è¡¨åä»¥ runtime_å¼€å¤´çš„è¡¨ç¤º ProxySQL å½“å‰è¿è¡Œçš„é…ç½®å†…å®¹ï¼Œä¸èƒ½é€šè¿‡ DML è¯­å¥ä¿®æ”¹ã€‚</p>
<p>åªèƒ½ä¿®æ”¹å¯¹åº”çš„ä¸ä»¥ runtime å¼€å¤´çš„è¡¨ï¼Œç„¶å â€œLOADâ€ ä½¿å…¶ç”Ÿæ•ˆï¼Œâ€œSAVEâ€ ä½¿å…¶å­˜åˆ°ç¡¬ç›˜ä»¥ä¾›ä¸‹æ¬¡é‡å¯åŠ è½½ã€‚</p>
<h2 id="å¤šå±‚çš„é…ç½®ç³»ç»Ÿ">å¤šå±‚çš„é…ç½®ç³»ç»Ÿ</h2>
<p><img src="C:%5CUsers%5CAdministrator%5CDesktop%5C1033265-20200210150442128-1932198210.png" alt=""></p>
<p>æ•´å¥—é…ç½®ç³»ç»Ÿåˆ†ä¸ºä¸‰å±‚ï¼šé¡¶å±‚ä¸º RUNTIME ,ä¸­é—´å±‚ä¸º MEMORY , åº•å±‚ä¹Ÿå°±æ˜¯æŒä¹…å±‚ DISK å’Œ CONFIG FILE ã€‚</p>
<p>RUNTIME ï¼š ä»£è¡¨ ProxySQL å½“å‰ç”Ÿæ•ˆçš„æ­£åœ¨ä½¿ç”¨çš„é…ç½®ï¼Œæ— æ³•ç›´æ¥ä¿®æ”¹è¿™é‡Œçš„é…ç½®ï¼Œå¿…é¡»è¦ä»ä¸‹ä¸€å±‚ â€œloadâ€ è¿›æ¥ã€‚
MEMORYï¼š MEMORY å±‚ä¸Šé¢è¿æ¥ RUNTIME å±‚ï¼Œä¸‹é¢è¿æ¥æŒä¹…å±‚ã€‚è¿™å±‚å¯ä»¥æ­£å¸¸æ“ä½œ ProxySQL  é…ç½®ï¼Œéšä¾¿ä¿®æ”¹ï¼Œä¸ä¼šå½±å“ç”Ÿäº§ç¯å¢ƒã€‚ä¿®æ”¹ä¸€ä¸ªé…ç½®ä¸€èˆ¬éƒ½æ˜¯ç°åœ¨ MEMORY å±‚å®Œæˆçš„ï¼Œç¡®è®¤æ­£å¸¸ä¹‹ååœ¨åŠ è½½è¾¾åˆ° RUNTIME å’Œ æŒä¹…åŒ–çš„ç£ç›˜ä¸Šã€‚</p>
<p>DISK å’Œ CONFIG FILEï¼šæŒä¹…åŒ–é…ç½®ä¿¡æ¯ï¼Œé‡å¯åå†…å­˜ä¸­çš„é…ç½®ä¿¡æ¯ä¼šä¸¢å¤±ï¼Œæ‰€éœ€è¦å°†é…ç½®ä¿¡æ¯ä¿ç•™åœ¨ç£ç›˜ä¸­ã€‚é‡å¯æ—¶ï¼Œå¯ä»¥ä»ç£ç›˜å¿«é€ŸåŠ è½½å›æ¥ã€‚</p>
<p>ä¸€èˆ¬åœ¨å†…å­˜é‚£å±‚ä¿®æ”¹ ,ç„¶åä¿å­˜åˆ°è¿è¡Œç³»ç»Ÿï¼Œä¿å­˜åˆ°ç£ç›˜æ•°æ®åº“ç³»ç»Ÿ</p>
<pre tabindex="0"><code>load xxx to runtime;
save xxx to disk;
</code></pre><ul>
<li>proxysql å¯åŠ¨æ—¶ï¼Œé¦–å…ˆå»æ‰¾/etc/proxysql.cnf æ‰¾åˆ°å®ƒçš„datadir,å¦‚æœdatadirä¸‹æœ‰proxysql.db å°±åŠ è½½proxysql.dbçš„é…ç½®</li>
<li>å¦‚æœå¯åŠ¨proxysqlæ—¶å¸¦æœ‰<code>--init</code>æ ‡å¿—ï¼Œä¼šç”¨/etc/proxsql.cnfçš„é…ç½®ï¼ŒæŠŠRuntimeï¼Œdiskå…¨éƒ¨åˆå§‹åŒ–ä¸€ä¸‹</li>
<li>åœ¨è°ƒç”¨æ˜¯è°ƒç”¨<code>--reload</code> ä¼šæŠŠ/etc/proxysql.cnf å’Œdisk ä¸­é…ç½®è¿›è¡Œåˆå¹¶ã€‚å¦‚æœå†²çªéœ€è¦ç”¨æˆ·å¹²é¢„ã€‚diskä¼šè¦†ç›–config fileã€‚</li>
</ul>
<h2 id="é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯">é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯</h2>
<p>é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯</p>
<pre tabindex="0"><code>
ProxySQL-Admin&gt;  show create table mysql_replication_hostgroups\G;
*************************** 1. row ***************************
       table: mysql_replication_hostgroups
Create Table: CREATE TABLE mysql_replication_hostgroups (
    writer_hostgroup INT CHECK (writer_hostgroup&gt;=0) NOT NULL PRIMARY KEY,
    reader_hostgroup INT NOT NULL CHECK (reader_hostgroup&lt;&gt;writer_hostgroup AND reader_hostgroup&gt;=0),
    check_type VARCHAR CHECK (LOWER(check_type) IN (&#39;read_only&#39;,&#39;innodb_read_only&#39;,&#39;super_read_only&#39;,&#39;read_only|innodb_read_only&#39;,&#39;read_only&amp;innodb_read_only&#39;)) NOT NULL DEFAULT &#39;read_only&#39;,
    comment VARCHAR NOT NULL DEFAULT &#39;&#39;, UNIQUE (reader_hostgroup))
1 row in set (0.00 sec)
</code></pre><p>é¦–å…ˆåˆ›å»ºå†™ç»„å’Œè¯»ç»„</p>
<p><code>insert ``into</code> <code>mysql_replication_hostgroups ( writer_hostgroup, reader_hostgroup, comment) values (10,20,``'proxy'``);</code></p>
<p>ç¡®ä¿æ­¤é…ç½®å‡å·²å†™å…¥ä¸‰ç§é…ç½®</p>
<pre tabindex="0"><code>ProxySQL-Admin&gt;  select * from main.mysql_replication_hostgroups;
+------------------+------------------+------------+---------+
| writer_hostgroup | reader_hostgroup | check_type | comment |
+------------------+------------------+------------+---------+
| 10               | 20               | read_only  | proxy   |
+------------------+------------------+------------+---------+
1 row in set (0.00 sec)

ProxySQL-Admin&gt;  select * from main.runtime_mysql_replication_hostgroups;
Empty set (0.00 sec)

ProxySQL-Admin&gt;  load mysql servers to runtime;
Query OK, 0 rows affected (0.00 sec)

ProxySQL-Admin&gt;  select * from main.runtime_mysql_replication_hostgroups;
+------------------+------------------+------------+---------+
| writer_hostgroup | reader_hostgroup | check_type | comment |
+------------------+------------------+------------+---------+
| 10               | 20               | read_only  | proxy   |
+------------------+------------------+------------+---------+
1 row in set (0.00 sec)

ProxySQL-Admin&gt;  use disk
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
ProxySQL-Admin&gt;  select * from disk.mysql_replication_hostgroups;
Empty set (0.00 sec)

ProxySQL-Admin&gt;  save mysql servers to disk
    -&gt; ;
Query OK, 0 rows affected (0.02 sec)

ProxySQL-Admin&gt;  select * from disk.mysql_replication_hostgroups;
+------------------+------------------+------------+---------+
| writer_hostgroup | reader_hostgroup | check_type | comment |
+------------------+------------------+------------+---------+
| 10               | 20               | read_only  | proxy   |
+------------------+------------------+------------+---------+
1 row in set (0.00 sec)

ProxySQL-Admin&gt; 
</code></pre><p><strong>ProxySQL ä¼šæ ¹æ®server çš„read _only çš„å–å€¼å°†æœåŠ¡å™¨è¿›è¡Œåˆ†ç»„ã€‚ read_only=0 çš„serverï¼Œmasterè¢«åˆ†åˆ°ç¼–å·ä¸º10çš„å†™ç»„ï¼Œread_only=1 çš„serverï¼Œslaveåˆ™è¢«åˆ†åˆ°ç¼–å·20çš„è¯»ç»„</strong></p>
<h2 id="å°†ä¸ªæœåŠ¡å™¨æ·»åŠ åˆ°mysql_serverè¡¨">å°†ä¸ªæœåŠ¡å™¨æ·»åŠ åˆ°mysql_serverè¡¨</h2>
<pre tabindex="0"><code>ProxySQL-Admin&gt;  show create table mysql_servers\G;
*************************** 1. row ***************************
       table: mysql_servers
Create Table: CREATE TABLE mysql_servers (
    hostgroup_id INT CHECK (hostgroup_id&gt;=0) NOT NULL DEFAULT 0,
    hostname VARCHAR NOT NULL,
    port INT CHECK (port &gt;= 0 AND port &lt;= 65535) NOT NULL DEFAULT 3306,
    gtid_port INT CHECK ((gtid_port &lt;&gt; port OR gtid_port=0) AND gtid_port &gt;= 0 AND gtid_port &lt;= 65535) NOT NULL DEFAULT 0,
    status VARCHAR CHECK (UPPER(status) IN (&#39;ONLINE&#39;,&#39;SHUNNED&#39;,&#39;OFFLINE_SOFT&#39;, &#39;OFFLINE_HARD&#39;)) NOT NULL DEFAULT &#39;ONLINE&#39;,
    weight INT CHECK (weight &gt;= 0 AND weight &lt;=10000000) NOT NULL DEFAULT 1,
    compression INT CHECK (compression IN(0,1)) NOT NULL DEFAULT 0,
    max_connections INT CHECK (max_connections &gt;=0) NOT NULL DEFAULT 1000,
    max_replication_lag INT CHECK (max_replication_lag &gt;= 0 AND max_replication_lag &lt;= 126144000) NOT NULL DEFAULT 0,
    use_ssl INT CHECK (use_ssl IN(0,1)) NOT NULL DEFAULT 0,
    max_latency_ms INT UNSIGNED CHECK (max_latency_ms&gt;=0) NOT NULL DEFAULT 0,
    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
    PRIMARY KEY (hostgroup_id, hostname, port) )
1 row in set (0.00 sec)

ERROR: 
No query specified
</code></pre><p>ä½¿ç”¨ä¸‹é¢çš„è¯­å¥ä¾æ¬¡æ’å…¥æˆ‘ä»¬åˆšåˆšæ­å»ºå¥½çš„çš„æœºå™¨ï¼ˆæ³¨æ„å†™å…¥ç»„è¿˜æ˜¯è¯»å–ç»„çš„åŒºåˆ†ï¼‰</p>
<pre tabindex="0"><code>insert into mysql_servers(hostgroup_id,hostname,port,comment) values (10,&#39;xxx.xxx.xxx.xxx&#39;,3306,&#34;è¯´æ˜&#34;);
</code></pre><p><strong>å°†ä¿¡æ¯åŒæ­¥åˆ°runtimeå’Œdisk</strong></p>
<pre tabindex="0"><code>load mysql servers to runtime;
save mysql servers to disk;
</code></pre><p>ä¸»è¦é€šè¿‡ä¸‹é¢ä¸‰å¥è¯ç²¾é€‰éªŒè¯</p>
<pre tabindex="0"><code> select * from disk.mysql_servers;
 select * from runtime_mysql_servers;
 select * from main.mysql_servers;
</code></pre><p>æ³¨æ„è§‚å¯Ÿ<code> select * from mysql_servers;</code>æ—¶<code>status</code>åˆ—å…¨ä¸º<code>ONLINE</code>å³å¯ã€‚</p>
<pre tabindex="0"><code> +--------------+-----------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------------------+
| hostgroup_id | hostname        | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment                   |
+--------------+-----------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------------------+
| 10           | xxx.xxx.xxx.114 | 3306 | 0         | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | ç¬¬ä¸€æ¬¡æµ‹è¯•çš„ä¸»æœº          |
| 20           | xxx.xxx.xxx.118 | 3306 | 0         | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | ç¬¬ä¸€æ¬¡æµ‹è¯•çš„ä»æœº1         |
| 20           | xxx.xxx.xxx.115 | 3306 | 0         | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | ç¬¬ä¸€æ¬¡æµ‹è¯•çš„ä»æœº2         |
+--------------+-----------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------------------+
3 rows in set (0.00 sec)
</code></pre><h2 id="proxysql-ç›‘æ§åç«¯èŠ‚ç‚¹">ProxySQL ç›‘æ§åç«¯èŠ‚ç‚¹</h2>
<p>ä¸º ProxySQL é…ç½®ç›‘æ§è´¦å·</p>
<pre tabindex="0"><code>
ProxySQL-Admin&gt;  set mysql-monitor_username=&#39;monitor&#39;;
Query OK, 1 row affected (0.00 sec)

ProxySQL-Admin&gt;  set mysql-monitor_password=&#39;Mm-123456&#39;;
Query OK, 1 row affected (0.00 sec)

ProxySQL-Admin&gt;  load mysql variables to runtime;
Query OK, 0 rows affected (0.00 sec)

ProxySQL-Admin&gt;  save mysql variables to disk;
Query OK, 136 rows affected (0.00 sec)
</code></pre><p>åœ¨ mysqlä¸»ä» çš„masterèŠ‚ç‚¹è¿›è¡Œè®¾ç½®è´¦å·å¯†ç </p>
<pre tabindex="0"><code>mysql&gt; create user &#39;monitor&#39;@&#39;%&#39; identified by &#39;Mm-123456&#39;;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; grant all privileges on *.* to &#39;monitor&#39;@&#39;%&#39;;
Query OK, 0 rows affected (0.00 sec)
</code></pre><p>éªŒè¯ç›‘æ§ä¿¡æ¯ï¼ŒProxySQL ç›‘æ§æ¨¡å—çš„æŒ‡æ ‡éƒ½ä¿å­˜åœ¨<code>monitoråº“çš„logè¡¨ä¸­</code></p>
<pre tabindex="0"><code>è¿æ¥ï¼šselect * from monitor.mysql_server_connect_log;
ç¨ç­‰ä¸€ä¼š ç»“æœå‡ºç° connect_error åˆ—å‡ºç° NULL å³å¯
å¿ƒè·³æ£€æµ‹pingï¼šselect * from mysql_server_ping_log limit 10;
readonly:select * from mysql_server_read_only_log limit 10;
</code></pre><h2 id="é…ç½®proxy">é…ç½®proxy</h2>
<p>SQL è¯·æ±‚æ‰€ä½¿ç”¨çš„ç”¨æˆ·é…ç½®ï¼Œéƒ½éœ€è¦å†MysqlèŠ‚ç‚¹åˆ›å»ºä¸Šã€‚</p>
<p>â€‹	åˆ›å»ºproxysql å¯¹å¤–è®¿é—®çš„è´¦æˆ·(master)</p>
<pre tabindex="0"><code>mysql&gt; create user &#39;proxysql&#39;@&#39;è¿™é‡Œæ˜¯proxyçš„ip&#39; identified by &#39;Proxy-123456&#39;;
Query OK, 0 rows affected (0.01 sec)

mysql&gt; grant all privileges on *.* to &#39;proxysql&#39;@&#39;è¿™é‡Œæ˜¯proxyçš„ip&#39; with grant option;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; flush privileges;
Query OK, 0 rows affected (0.01 sec)
</code></pre><p>åœ¨ProxySQLä¸­éœ€è¦è®¾ç½®çš„è¡¨æ˜¯</p>
<pre tabindex="0"><code>ProxySQL-Admin&gt;  show create table mysql_users\G;
*************************** 1. row ***************************
       table: mysql_users
Create Table: CREATE TABLE mysql_users (
    username VARCHAR NOT NULL,
    password VARCHAR,
    active INT CHECK (active IN (0,1)) NOT NULL DEFAULT 1,
    use_ssl INT CHECK (use_ssl IN (0,1)) NOT NULL DEFAULT 0,
    default_hostgroup INT NOT NULL DEFAULT 0,  #é»˜è®¤è·¯ç”±ç›®æ ‡
    default_schema VARCHAR,
    schema_locked INT CHECK (schema_locked IN (0,1)) NOT NULL DEFAULT 0,
    transaction_persistent INT CHECK (transaction_persistent IN (0,1)) NOT NULL DEFAULT 1,
    fast_forward INT CHECK (fast_forward IN (0,1)) NOT NULL DEFAULT 0,
    backend INT CHECK (backend IN (0,1)) NOT NULL DEFAULT 1,
    frontend INT CHECK (frontend IN (0,1)) NOT NULL DEFAULT 1,
    max_connections INT CHECK (max_connections &gt;=0) NOT NULL DEFAULT 10000,
    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
    PRIMARY KEY (username, backend),
    UNIQUE (username, frontend))
1 row in set (0.00 sec)

ERROR: 
No query specified
</code></pre><p>æˆ‘ä»¬å°†åœ¨<code>master</code>ä¸Šè®¾ç½®ç”¨äº<code>proxy</code>è®¿é—®çš„è´¦æˆ·æ’å…¥åˆ°<code>ProxySql</code>çš„<code>mysql_users</code>è¡¨ä¸­</p>
<pre tabindex="0"><code>ProxySQL-Admin&gt;  insert into mysql_users(username,password,default_hostgroup) values(&#39;proxysql&#39;,&#39;Proxy-123456&#39;,10);
Query OK, 1 row affected (0.00 sec)
ProxySQL-Admin&gt;  load mysql users to runtime;
Query OK, 0 rows affected (0.00 sec)

ProxySQL-Admin&gt;  save mysql users to disk;
Query OK, 0 rows affected (0.01 sec)
</code></pre><pre tabindex="0"><code>ProxySQL-Admin&gt;  select * from mysql_users\G;
*************************** 1. row ***************************
              username: proxysql
              password: Proxy-123456
                active: 1
               use_ssl: 0
     default_hostgroup: 10
        default_schema: NULL
         schema_locked: 0
transaction_persistent: 1
          fast_forward: 0
               backend: 1
              frontend: 1
       max_connections: 10000
               comment: 
1 row in set (0.00 sec)

ERROR: 
No query specified
</code></pre><p>æ­¤æ—¶å¯ä»¥åœ¨æœ‰æƒé™ç™»å½•çš„æœºå™¨ç”¨proxysqlè´¦æˆ·ç™»å½•åˆ›å»ºåº“è°ƒè¯•çœ‹çœ‹ã€‚</p>
<p>å¿˜è®°è‡ªå·±ç™»å½•åˆ°é‚£ä¸ªæœåŠ¡å¯ä»¥ç”¨<code> select @@server_id;</code>æŸ¥çœ‹æ‰€åœ¨æœºå™¨ã€‚</p>
<h3 id="é…ç½®è¯»å†™åˆ†ç¦»">é…ç½®è¯»å†™åˆ†ç¦»</h3>
<h4 id="è·¯ç”±è§„åˆ™">è·¯ç”±è§„åˆ™</h4>
<p>è·¯ç”±è§„åˆ™é…ç½®éå¸¸çµæ´»ï¼Œå¯ä»¥åŸºäºschemaï¼Œä¹Ÿå¯ä»¥åŸºäºç”¨æˆ·ï¼Œæˆ–å•ä¸ªsqlè¯­å¥å®ç°è·¯ç”±å®šåˆ¶ã€‚</p>
<p>ã€<strong>å®é™…è¿‡ç¨‹ä¸­åº”è¯¥ä»æ‰‹æœºçš„æ…¢æ—¥å¿—å„é¡¹æŒ‡æ ‡ä¸­æ‰¾å‡ºå‹åŠ›å¤§ï¼Œæ‰§è¡Œé¢‘ç¹çš„è¯­å¥å•ç‹¬å†™è·¯ç”±è§„åˆ™å’Œç¼“å­˜ï¼Œå»ºè®®ä½¿ç”¨hash code å€¼åšè¯»å†™çº¹ç†ï¼Œä¸è¦å»ºå¤ªå¤šè§„åˆ™</strong>ã€‘</p>
<p>mysql_query_rules_fast_routingæ˜¯mysql_query_rules</p>
<p>ä»‹ç»ä¸€ä¸‹æ”¹è¡¨mysql_query_rulesçš„å‡ ä¸ªå­—æ®µï¼š
<code>active</code>ï¼šæ˜¯å¦å¯ç”¨è¿™ä¸ªè§„åˆ™ï¼Œ1è¡¨ç¤ºå¯ç”¨ï¼Œ0è¡¨ç¤ºç¦ç”¨
<code>match_pattern</code> å­—æ®µå°±æ˜¯ä»£è¡¨è®¾ç½®è§„åˆ™
<code>destination_hostgroup</code> å­—æ®µä»£è¡¨é»˜è®¤æŒ‡å®šçš„åˆ†ç»„ï¼Œ
<code>apply</code> ä»£è¡¨çœŸæ­£æ‰§è¡Œåº”ç”¨è§„åˆ™ã€‚</p>
<h4 id="è§„åˆ™çš„å†™å…¥">è§„åˆ™çš„å†™å…¥</h4>
<p>ProxySQL æ˜¯æ ¹æ®<code>rule_id</code>çš„é¡ºåºæ¥è¿›è¡Œè§„åˆ™åŒ¹é…çš„æ³¨æ„è§„åˆ™çš„ç¼–å†™é¡ºåº</p>
<p>æ‰€æœ‰ä»¥select å¼€å¤´çš„è¯­å¥å…¨éƒ¨åˆ†é…åˆ°è¯»ç»„ä¸­ï¼Œä¸Šé¢å»ºç«‹è¯»ç»„ç¼–å·æ˜¯20</p>
<p><code>insert into mysql_query_rules(rule_id,active,match_pattern,destination_hostgroup,apply) values (2,1,'^select',20,1);</code></p>
<p>è¯´æœ‰ä»¥insertå¼€å¤´çš„è¯­å¥å…¨éƒ¨åˆ†é…åˆ°å†™ç»„ä¸­</p>
<p><code>insert into mysql_query_rules(rule_id,active,match_pattern,destination_hostgroup,apply) values (1,1,'^SELECT.*FOR UPDATE$',10,1);</code></p>
<p><code>insert into mysql_query_rules(rule_id,active,match_pattern,destination_hostgroup,apply) values (3,1,'^insert',10,1);</code></p>
<p>æ³¨æ„è¦</p>
<pre tabindex="0"><code>load mysql query rules to runtime;
save mysql query rules to disk;
</code></pre><h4 id="è¯»å†™åˆ†ç¦»æµ‹è¯•">è¯»å†™åˆ†ç¦»æµ‹è¯•</h4>
<p>åœ¨ProxySQLçš„ä¸»æœºä¸Šè¿è¡Œ</p>
<h5 id="æµ‹è¯•è¯»">æµ‹è¯•è¯»</h5>
<pre tabindex="0"><code>mysql -uproxysql -pProxy-123456 -h 127.0.0.1 -P 6033 -e &#34;select @@server_id&#34;;
å¯ä»¥è¿”å›æ­£ç¡®çš„server_idå³å¯ï¼Œå› ä¸ºæˆ‘çš„åå°æ˜¯ä¿©å°åªè¯»æœºå™¨ï¼Œæ‰€ä»¥ä¼šäº¤æ›¿å‡ºç°è®¿é—®ä¿©å°æœºå™¨çš„server_id;


mysql&gt; select @@server_id for update;  æ­¤è¯­å¥SELECT...FOR UPDATE ä¼šç”³è¯·å†™é”ï¼Œæ‰€ä»¥ç”¨åœ¨è¿™é‡Œæ¯”è¾ƒåˆé€‚ã€‚
+-------------+
| @@server_id |
+-------------+
|         114 |
+-------------+
1 row in set (0.00 sec)
</code></pre><h5 id="æµ‹è¯•å†™">æµ‹è¯•å†™</h5>
<pre tabindex="0"><code>mysql -uproxysql -pProxy-123456 -h 127.0.0.1 -P 6033 ç™»å½•å
mysql&gt; begin;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; insert into hanzhongtest.edu_user values(9,&#34;æµ‹è¯•å†™3&#34;,&#34;wahah&#34;);
Query OK, 1 row affected (0.00 sec)

mysql&gt; select @@server_id;
+-------------+
| @@server_id |
+-------------+
|         114 |
+-------------+
1 row in set (0.00 sec)

mysql&gt; commit;
Query OK, 0 rows affected (0.00 sec)
</code></pre><h4 id="æŸ¥çœ‹è·¯ç”±ä¿¡æ¯">æŸ¥çœ‹è·¯ç”±ä¿¡æ¯</h4>
<p>ä½¿ç”¨adminè´¦å·ç™»å½•ProxySQL</p>
<pre tabindex="0"><code>[root@localhost proxysql]# mysql -u admin -padmin -h 127.0.0.1 -P 6032 --prompt=&#39;ProxySQL-Admin&gt;  &#39;


ProxySQL-Admin&gt;  SELECT hostgroup hg,
    -&gt;               sum_time,
    -&gt;               count_star,
    -&gt;               digest_text 
    -&gt;        FROM stats_mysql_query_digest
    -&gt;        ORDER BY sum_time DESC;
+----+----------+------------+-------------------------------------------------------+
| hg | sum_time | count_star | digest_text                                           |
+----+----------+------------+-------------------------------------------------------+
| 20 | 83455    | 70         | select @@server_id                                    |
| 10 | 4383     | 2          | commit                                                |
| 10 | 1275     | 2          | insert into hanzhongtest.edu_user values(?,?,?)       |
| 10 | 1205     | 1          | start transantion                                     |
| 20 | 1015     | 1          | select * from stats_mysql_query_digest                |
| 10 | 798      | 2          | begin insert into hanzhongtest.edu_user values(?,?,?) |
| 10 | 792      | 2          | begin                                                 |
| 10 | 454      | 1          | select @@server_id                                    |
| 10 | 0        | 71         | select @@version_comment limit ?                      |
+----+----------+------------+-------------------------------------------------------+
9 rows in set (0.00 sec)
</code></pre><h3 id="æ€»ç»“">æ€»ç»“ï¼š</h3>
<p>è·¯ç”±è§„åˆ™æ¯”è¾ƒçµæ´»éœ€è¦å¤šçœ‹<a href="https://github.com/sysown/proxysql/wiki">å®˜æ–¹æ–‡æ¡£</a></p>
<p>åˆ©ç”¨ProxySQLè¯»å†™åˆ†ç¦»å¯ä»¥é™ä½ä¸»åº“çš„å‹åŠ›ï¼Œä½†æ˜¯å½“ä¸»åº“å®•æœºåé›†ç¾¤å°†ä¸èƒ½å†å†™ã€‚æ‰€ä»¥éœ€è¦replication managerå®ç°é«˜å¯ç”¨çš„ååŠ©ã€‚</p>
<p>å…¶æ¬¡éœ€è¦å®éªŒå¯¹äº<code>mysql galera cluster</code>çš„è¯»å†™åˆ†ç¦»å’Œè´Ÿè½½ã€‚</p>
<h4 id="é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜</h4>
<p>1.å»ºç«‹è´¦æˆ·æ˜¯è®¿é—®IPåº”æ˜ç¡®</p>
<p>2.firewalld å®éªŒçš„æ—¶å€™è¦ä¸å…³æ‰ï¼Œè¦ä¸å†™è§„åˆ™å¼€æ”¾ç«¯å£ã€‚</p>
<h2 id="proxysql-çš„é«˜å¯ç”¨">ProxySql çš„é«˜å¯ç”¨</h2>
<table>
<thead>
<tr>
<th>ç¼–å†™äºº</th>
<th>ç¼–å†™æ—¶é—´</th>
<th>ç¼–å†™è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç« ç€šä¸­</td>
<td>2020-9-12</td>
<td>æ¥ä¸Šä¸€ç¯‡[proxysql è¯»å†™åˆ†ç¦»](<a href="http://wiki-private.capitalonline.net:8090/pages/viewpage.action?pageId=59474862">ProxySQL è¯»å†™åˆ†ç¦»</a>)ä¸€èµ·è§‚çœ‹è¾ƒä½³</td>
</tr>
</tbody>
</table>
<p>æœ‰ä¸¤ä¸ªç»„ä»¶å®ç°äº†ProxySQLé›†ç¾¤</p>
<ul>
<li>
<p><strong>monitoring(é›†ç¾¤ç›‘æ§ç»„ä»¶)</strong></p>
</li>
<li>
<p><strong>re-configuration(è¿œç¨‹é…ç½®)</strong></p>
<p>ä¿©ç»„ä»¶éƒ½æœ‰4å¼ è¡¨</p>
<p><strong>-</strong> mysql_query_rules
<strong>-</strong> mysql_servers
<strong>-</strong> mysql_users
<strong>-</strong> proxysql_servers</p>
</li>
</ul>
<h3 id="ç›¸å…³å˜é‡">ç›¸å…³å˜é‡</h3>
<p>Admin variables ï¼šä½¿ç”¨<code>load admin variables to runtime</code>ä½¿å…¶ç”Ÿæ•ˆ</p>
<h4 id="1ç”¨äºåŒæ­¥çš„å˜é‡">1.ç”¨äºåŒæ­¥çš„å˜é‡</h4>
<pre><code>- `admin-checksum_mysql_query_rules` boolean å˜é‡ï¼Œé»˜è®¤tureï¼Œå½“ä½¿ç”¨`load mysql query rules to runtime`æ—¶ï¼Œä¼šç”Ÿæˆæ–°çš„é…ç½®æ ¡éªŒç ã€‚å¦‚æœæ˜¯false æ–°çš„é…ç½®ä¸ä¼šè‡ªåŠ¨å¹¿æ’­å’ŒåŒæ­¥è¿œç«¯æ•°æ®ã€‚
- `admin-checksum_mysql_servers` å¸ƒå°”ç±»å‹ï¼Œé»˜è®¤ture `load mysql servers to runtime` åŒä¸Š
- `admin-chechsum_mysql_users`å¸ƒå°”ç±»å‹ï¼Œé»˜è®¤ture `load mysql users to runtime`,åŒä¸Šï¼Œä½†æ˜¯ç”¨æˆ·æœ‰æ•°ç™¾ä¸‡ï¼Œä¸ºäº†ä¸å½±å“æ€§èƒ½å°±è¦è®¾ç½®ä¸ºfalseã€‚
</code></pre>
<h4 id="2é›†ç¾¤å‡­è¯å˜é‡">2.é›†ç¾¤å‡­è¯å˜é‡</h4>
<ul>
<li><code>admin-cluster_username</code></li>
<li><code>admin-cluser_password</code></li>
</ul>
<p>è¿™æ˜¯ç”¨äºç›‘æ§å…¶ä»–ProxySQLå®ä¾‹ ï¼Œè¿™ä¿©ä¸ªå˜é‡éœ€è¦å†<code>admin-admin_credentials</code>ä¸­å­˜åœ¨ã€‚</p>
<h4 id="3æ£€æŸ¥é¢‘ç‡å’Œé—´éš”æ—¶é—´">3.æ£€æŸ¥é¢‘ç‡å’Œé—´éš”æ—¶é—´</h4>
<ul>
<li><code>admin-cluster_check_interval_ms</code>è¿™ä¸ªå˜é‡å®šä¹‰äº†æ£€æŸ¥chechsumsçš„æ—¶é—´ï¼Œé»˜è®¤1000,æœ€å°10ï¼Œæœ€å¤§ 300000.</li>
<li><code>admin-cluster_check_status_frequency</code>å®šä¹‰äº†å¤šå°‘æ¬¡checksumsæ£€æŸ¥å°±éªŒè¯ä¸€æ¬¡è¿æ¥æ€§ã€‚</li>
</ul>
<h4 id="4å°†é…ç½®åŒæ­¥åˆ°ç£ç›˜">4.å°†é…ç½®åŒæ­¥åˆ°ç£ç›˜</h4>
<p>åœ¨è¿œç¨‹åŒæ­¥é…ç½®ä¹‹åï¼Œé€šå¸¸æœ€å¥½çš„åšæ³•æ˜¯ç«‹å³å°†æ–°çš„æ›´æ”¹ä¿å­˜åˆ°ç£ç›˜ã€‚è¿™æ ·é‡å¯æ—¶ï¼Œæ›´æ”¹çš„é…ç½®ä¸ä¼šä¸¢å¤±ã€‚
<strong>-</strong> <code>admin-cluster_mysql_query_rules_save_to_disk</code>
<strong>-</strong> <code>admin-cluster_mysql_servers_save_to_disk</code>
<strong>-</strong> <code>admin-cluster_mysql_users_save_to_disk</code>
<strong>-</strong> <code>admin-cluster_proxysql_servers_save_to_disk</code></p>
<p>è¿™å‡ ä¸ªå˜é‡éƒ½æ˜¯å¸ƒå°”å€¼ã€‚å½“è®¾ç½®ä¸ºtrue(é»˜è®¤å€¼)æ—¶ï¼Œåœ¨è¿œç¨‹åŒæ­¥å¹¶loadåˆ°runtimeåï¼Œæ–°çš„mysql_query_rulesã€mysql_serversã€mysql_usersã€proxysql_serversé…ç½®ä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚</p>
<h4 id="5æ˜¯å¦éœ€è¦è¿œç¨‹åŒæ­¥å˜é‡">5.æ˜¯å¦éœ€è¦è¿œç¨‹åŒæ­¥å˜é‡</h4>
<p>ç”±äºæŸäº›åŸå› ï¼Œå¯èƒ½å¤šä¸ªProxySQLå®ä¾‹ä¼šåœ¨åŒä¸€æ—¶é—´è¿›è¡Œé‡æ–°é…ç½®ã€‚
ä¾‹å¦‚ï¼Œæ¯ä¸ªProxySQLå®ä¾‹éƒ½åœ¨ç›‘æ§MySQLçš„replicationï¼Œä¸”è‡ªåŠ¨æ¢æµ‹åˆ°MySQLçš„æ•…éšœè½¬ç§»ï¼Œåœ¨ä¸€ä¸ªæçŸ­çš„æ—¶é—´å†…(å¯èƒ½å°äº1ç§’)ï¼Œè¿™äº›ProxySQLå®ä¾‹å¯èƒ½ä¼šè‡ªåŠ¨è°ƒæ•´æ–°çš„é…ç½®ï¼Œè€Œæ— éœ€é€šè¿‡å…¶å®ƒProxySQLå®ä¾‹æ¥åŒæ­¥æ–°é…ç½®ã€‚</p>
<p>ç±»ä¼¼çš„è¿˜æœ‰ï¼Œå½“æ‰€æœ‰ProxySQLå®ä¾‹éƒ½æ¢æµ‹åˆ°äº†å’ŒæŸå®ä¾‹çš„ä¸´æ—¶çš„ç½‘ç»œé—®é¢˜ï¼Œæˆ–è€…æŸä¸ªMySQLèŠ‚ç‚¹æ¯”è¾ƒæ…¢(replication lag,  æ‹–åè…¿)ï¼Œè¿™äº›ProxySQLå®ä¾‹éƒ½ä¼šè‡ªåŠ¨åœ°é¿å¼€è¿™äº›èŠ‚ç‚¹ã€‚è¿™æ—¶å„ProxySQLå®ä¾‹ä¹Ÿæ— éœ€ä»å…¶å®ƒèŠ‚ç‚¹å¤„åŒæ­¥é…ç½®ï¼Œè€Œæ˜¯åŒæ—¶è‡ªåŠ¨å®Œæˆæ–°çš„é…ç½®ã€‚</p>
<p>é…ç½®ProxySQLé›†ç¾¤ï¼Œè®©å„ProxySQLå®ä¾‹æš‚æ—¶æ— éœ€ä»å…¶å®ƒå®ä¾‹å¤„åŒæ­¥æŸäº›é…ç½®ï¼Œè€Œæ˜¯ç­‰å¾…ä¸€å®šæ¬¡æ•°çš„æ£€æŸ¥ä¹‹åï¼Œå†è§¦å‘è¿œç¨‹åŒæ­¥ã€‚ä½†æ˜¯ï¼Œå¦‚æœæœ¬åœ°å’Œè¿œç¨‹èŠ‚ç‚¹çš„è¿™äº›å˜é‡é˜ˆå€¼ä¸åŒï¼Œåˆ™è¿˜æ˜¯ä¼šè§¦å‘è¿œç¨‹åŒæ­¥ã€‚</p>
<p><strong>-</strong> <code>admin-cluster_mysql_query_rules_diffs_before_sync</code>
<strong>-</strong> <code>admin-cluster_mysql_servers_diffs_before_sync</code>
<strong>-</strong> <code>admin-cluster_mysql_users_diffs_before_sync</code>
<strong>-</strong> <code>admin-cluster_proxysql_servers_diffs_before_sync</code></p>
<p>åˆ†åˆ«å®šä¹‰ç»è¿‡å¤šå°‘æ¬¡çš„&quot;æ— æ³•åŒ¹é…&quot;æ£€æŸ¥ä¹‹åï¼Œè§¦å‘mysql_query_rulesã€mysql_serversã€mysql_usersã€proxysql_serversé…ç½®çš„è¿œç¨‹åŒæ­¥ã€‚é»˜è®¤å€¼3æ¬¡ï¼Œæœ€å°å€¼0ï¼Œè¡¨ç¤ºæ°¸ä¸è¿œç¨‹åŒæ­¥ï¼Œæœ€å¤§å€¼1000ã€‚</p>
<p>æ¯”å¦‚å„å®ä¾‹ç›‘æ§mysql_serversé…ç½®å¹¶åšæ ¡éªŒç æ£€æŸ¥ï¼Œå¦‚æœæŸå®ä¾‹å’Œæœ¬åœ°é…ç½®ä¸åŒï¼Œå½“å¤šæ¬¡æ£€æµ‹åˆ°éƒ½ä¸åŒæ—¶ï¼Œå°†æ ¹æ®load to runtimeçš„æ—¶é—´æˆ³å†³å®šæ˜¯å¦è¦ä»è¿œç«¯å°†mysql_serversåŒæ­¥åˆ°æœ¬åœ°ã€‚</p>
<h4 id="6å»¶è¿ŸåŒæ­¥">6.å»¶è¿ŸåŒæ­¥</h4>
<p>ProxySQL Cluster å¯ä»¥å®šä¹‰è¾¾åˆ°å¤šå°‘ä¸ªchecksum ä¸åŒä¹‹åï¼Œæ‰åœ¨é›†ç¾¤å†…éƒ¨è¿›è¡Œé…ç½®åŒæ­¥ã€‚
query rules, servers, users å’Œproxysql servers åˆ†åˆ«æœ‰admin-cluster_XXX_diffs_before_sync ç›¸å…³çš„å‚æ•°ï¼Œå–å€¼èŒƒå›´0 ï½ 1000ï¼Œ0 ä»£è¡¨ä»ä¸åŒæ­¥ã€‚é»˜è®¤3ã€‚</p>
<h3 id="éœ€è¦é…ç½®çš„è¡¨">éœ€è¦é…ç½®çš„è¡¨</h3>
<h4 id="1proxysql_servers">1.proxysql_servers</h4>
<p>å®šä¹‰proxyssqlé›†ç¾¤ä¸­æœ‰å“ªäº›å®ä¾‹ï¼Œå¯ä»¥åœ¨çº¿insertï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚</p>
<pre tabindex="0"><code>ProxySQL-Admin&gt;  show create table proxysql_servers;
+------------------+--------------------------
| table            | Create Table            |
+------------------+--------------------------
| proxysql_servers | CREATE TABLE proxysql_servers (
    hostname VARCHAR NOT NULL,
    port INT NOT NULL DEFAULT 6032,
    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 0,
    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
    PRIMARY KEY (hostname, port) ) |
+------------------+--------------------------
1 row in set (0.00 sec)
</code></pre><p>ProxySQLåªæœ‰åœ¨ç£ç›˜æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ–è€…ä½¿ç”¨äº†&ndash;initialé€‰é¡¹æ—¶æ‰ä¼šè¯»å–ä¼ ç»Ÿé…ç½®æ–‡ä»¶ã€‚</p>
<h4 id="2runtime_proxysql_servers">2.runtime_proxysql_servers</h4>
<p>æ­£å¦‚å…¶å®ƒruntime_è¡¨ä¸€æ ·ï¼Œruntime_proxysql_serversè¡¨å’Œproxysql_serversçš„ç»“æ„å®Œå…¨ä¸€è‡´ï¼Œåªä¸è¿‡å®ƒæ˜¯runtimeæ•°æ®ç»“æ„ä¸­çš„é…ç½®ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ­£åœ¨ç”Ÿæ•ˆçš„é…ç½®ã€‚è¯¥è¡¨çš„å®šä¹‰è¯­å¥å¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>| runtime_proxysql_servers | CREATE TABLE runtime_proxysql_servers (
    hostname VARCHAR NOT NULL,
    port INT NOT NULL DEFAULT 6032,
    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 0,
    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
    PRIMARY KEY (hostname, port) ) |
</code></pre><h4 id="3runtime_checksums_values">3.runtime_checksums_values</h4>
<p>è¿™ä¸ªä¸æ˜¯åŸºäºå†…å­˜çš„ã€‚ç”¨äº load to runtimeæ—¶çš„ä¿¡æ¯ã€‚</p>
<pre tabindex="0"><code>| runtime_checksums_values | CREATE TABLE runtime_checksums_values (
    name VARCHAR NOT NULL,
    version INT NOT NULL,
    epoch INT NOT NULL,
    checksum VARCHAR NOT NULL,
    PRIMARY KEY (name)) |
</code></pre><p>- nameï¼šæ¨¡å—çš„åç§°
- versionï¼šæ‰§è¡Œäº†å¤šå°‘æ¬¡load to runtimeæ“ä½œï¼ŒåŒ…æ‹¬æ‰€æœ‰éšå¼å’Œæ˜¾å¼æ‰§è¡Œçš„(æŸäº›äº‹ä»¶ä¼šå¯¼è‡´ProxySQLå†…éƒ¨è‡ªåŠ¨æ‰§è¡Œload to runtimeå‘½ä»¤)
- epochï¼šæœ€è¿‘ä¸€æ¬¡æ‰§è¡Œload to runtimeçš„æ—¶é—´æˆ³
- checksumï¼šæ‰§è¡Œload to runtimeæ—¶ç”Ÿæˆçš„é…ç½®æ ¡éªŒç (checksum)</p>
<p><strong>ç‰¹åˆ«æ³¨æ„ï¼š</strong>  ç›®å‰6ä¸ªç»„ä»¶ä¸­åªæœ‰4ç§æ¨¡å—çš„é…ç½®ä¼šç”Ÿæˆå¯¹åº”çš„æ ¡éªŒç (checksum)ï¼Œä¸èƒ½ç”Ÿæˆçš„ç»„ä»¶æ˜¯ï¼šadmin_variablesï¼Œmysql_variablesã€‚ checnsum åªæœ‰åœ¨æ‰§è¡Œäº†load to run ï¼Œå¹¶ä¸”admin-checksum_XXX = true æ—¶ï¼Œæ‰å¯ä»¥æ­£å¸¸ç”Ÿæˆã€‚å³:
- LOAD MYSQL QUERY RULES TO RUNTIMEï¼šå½“admin-checksum_mysql_query_rules=trueæ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„mysql_query_rulesé…ç½®æ ¡éªŒç 
- LOAD MYSQL SERVERS TO RUNTIMEï¼šå½“admin-checksum_mysql_servers=trueæ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„mysql_serversé…ç½®æ ¡éªŒç 
- LOAD MYSQL USERS TO RUNTIMEï¼šå½“admin-checksum_mysql_users=trueæ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„mysql_usersé…ç½®æ ¡éªŒç 
- LOAD PROXYSQL SERVERS TO RUNTIMEï¼šæ€»æ˜¯ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„proxysql_serversé…ç½®æ ¡éªŒç 
- LOAD ADMIN VARIABLES TO RUNTIMEï¼šä¸ç”Ÿæˆæ ¡éªŒç 
- LOAD MYSQL VARIABLES TO RUNTIMEï¼šä¸ç”Ÿäº§æ ¡éªŒç </p>
<p><strong>New commands ï¼ˆæ–°å‘½ä»¤ï¼‰:</strong>
- LOAD PROXYSQL SERVERS FROM MEMORY / LOAD PROXYSQL SERVERS TO RUNTIME
ä»å†…å­˜æ•°æ®åº“ä¸­åŠ è½½proxysql serversé…ç½®åˆ°runtimeæ•°æ®ç»“æ„
- SAVE PROXYSQL SERVERS TO MEMORY / SAVE PROXYSQL SERVERS FROM RUNTIME
å°†proxysql serversé…ç½®ä»runtimeæ•°æ®ç»“æ„æŒä¹…åŒ–ä¿å­˜åˆ°å†…å­˜æ•°æ®åº“ä¸­
- LOAD PROXYSQL SERVERS TO MEMORY / LOAD PROXYSQL SERVERS FROM DISK
ä»ç£ç›˜æ•°æ®åº“ä¸­åŠ è½½proxysql serversé…ç½®åˆ°å†…å­˜æ•°æ®åº“ä¸­
- LOAD PROXYSQL SERVERS FROM CONFIG
ä»ä¼ ç»Ÿé…ç½®æ–‡ä»¶ä¸­åŠ è½½proxysql serversé…ç½®åˆ°å†…å­˜æ•°æ®åº“ä¸­
- SAVE PROXYSQL SERVERS FROM MEMORY / SAVE PROXYSQL SERVERS TO DISK
å°†proxysql serversé…ç½®ä»å†…å­˜æ•°æ®åº“ä¸­æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜æ•°æ®åº“ä¸­</p>
<h3 id="stats-tables">stats tables</h3>
<h4 id="1stats_proxysql_servers_checksums">1.stats_proxysql_servers_checksums</h4>
<p>è®°å½•é›†ç¾¤ä¸­å„ä¸ªå®ä¾‹çš„ç»„ä»¶checksum ä¿¡æ¯ã€‚</p>
<pre tabindex="0"><code> show create table stats.stats_proxysql_servers_checksums;
| stats_proxysql_servers_checksums | CREATE TABLE stats_proxysql_servers_checksums (
    hostname VARCHAR NOT NULL,
    port INT NOT NULL DEFAULT 6032,
    name VARCHAR NOT NULL,
    version INT NOT NULL,
    epoch INT NOT NULL,
    checksum VARCHAR NOT NULL,
    changed_at INT NOT NULL,
    updated_at INT NOT NULL,
    diff_check INT NOT NULL,
    PRIMARY KEY (hostname, port, name) ) |
</code></pre><p>å„å­—æ®µæ„ä¹‰å¦‚ä¸‹ï¼š
- hostnameï¼šProxySQLå®ä¾‹çš„ä¸»æœºå
- portï¼šProxySQLå®ä¾‹çš„ç«¯å£
- nameï¼šå¯¹ç«¯runtime_checksums_valuesä¸­æŠ¥å‘Šçš„æ¨¡å—åç§°
- versionï¼šå¯¹ç«¯runtime_checksum_valuesä¸­æŠ¥å‘Šçš„checksumçš„ç‰ˆæœ¬
<strong>æ³¨æ„</strong>ï¼ŒProxySQLå®ä¾‹åˆšå¯åŠ¨æ—¶version=1ï¼šProxySQLå®ä¾‹å°†æ°¸è¿œä¸ä¼šä»version=1çš„å®ä¾‹å¤„åŒæ­¥é…ç½®æ•°æ®ï¼Œå› ä¸ºä¸€ä¸ªåˆšåˆšå¯åŠ¨çš„ProxyQLå®ä¾‹ä¸å¤ªå¯èƒ½æ˜¯çœŸç›¸çš„æ¥æºï¼Œè¿™å¯ä»¥é˜²æ­¢æ–°çš„è¿æ¥èŠ‚ç‚¹ç ´åå½“å‰é›†ç¾¤é…ç½®
- epochï¼šå¯¹ç«¯runtime_checksums_valuesä¸­æŠ¥å‘Šçš„checksumçš„æ—¶é—´æˆ³epochå€¼
- checksumï¼šå¯¹ç«¯runtime_checksums_valuesä¸­æŠ¥å‘Šçš„checksumå€¼
- changed_atï¼šæ¢æµ‹åˆ°checksumå‘ç”Ÿå˜åŒ–çš„æ—¶é—´æˆ³
- updated_atï¼šæœ€è¿‘ä¸€æ¬¡æ›´æ–°è¯¥ç±»é…ç½®çš„æ—¶é—´æˆ³
- diff_checkï¼šä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºè®°å½•æ¢æµ‹åˆ°çš„å¯¹ç«¯å’Œæœ¬åœ°checksumå€¼å·²æœ‰å¤šå°‘æ¬¡ä¸åŒ
éœ€è¦ç­‰å¾…è¾¾åˆ°é˜ˆå€¼åï¼Œæ‰ä¼šè§¦å‘é‡æ–°é…ç½®ã€‚å‰é¢å·²ç»è¯´æ˜ï¼Œåœ¨å¤šä¸ªProxySQLå®ä¾‹åŒæ—¶æˆ–æçŸ­æ—¶é—´å†…åŒæ—¶æ›´æ”¹é…ç½®æ—¶ï¼Œå¯ä»¥è®©ProxySQLç­‰å¾…å¤šæ¬¡æ¢æµ‹ä¹‹åå†å†³å®šæ˜¯å¦ä»è¿œç«¯åŒæ­¥é…ç½®ã€‚è¿™ä¸ªå­—æ®µæ­£æ˜¯ç”¨äºè®°å½•æ¢æµ‹åˆ°çš„é…ç½®ä¸åŒæ¬¡æ•°ã€‚å¦‚æœdiff_checksä¸æ–­å¢åŠ å´ä»æœªè§¦å‘åŒæ­¥æ“ä½œï¼Œè¿™æ„å‘³ç€å¯¹ç«¯ä¸æ˜¯å¯ä¿¡ä»»çš„åŒæ­¥æºï¼Œä¾‹å¦‚å¯¹ç«¯çš„version=1ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæŸå¯¹ç«¯èŠ‚ç‚¹ä¸å’ŒProxySQLé›†ç¾¤ä¸­çš„å…¶å®ƒå®ä¾‹è¿›è¡Œé…ç½®åŒæ­¥ï¼Œè¿™æ„å‘³ç€é›†ç¾¤æ²¡æœ‰å¯ä¿¡ä»»çš„åŒæ­¥æºã€‚è¿™ç§æƒ…å†µå¯èƒ½æ˜¯å› ä¸ºé›†ç¾¤ä¸­æ‰€æœ‰å®ä¾‹å¯åŠ¨æ—¶çš„é…ç½®éƒ½ä¸ä¸€æ ·ï¼Œå®ƒä»¬æ— æ³•è‡ªåŠ¨åˆ¤æ–­å“ªä¸ªé…ç½®æ‰æ˜¯æ­£ç¡®çš„ã€‚å¯ä»¥åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œload to runtimeï¼Œä½¿è¯¥èŠ‚ç‚¹è¢«é€‰ä¸¾ä¸ºè¯¥ç±»é…ç½®çš„å¯ä¿¡ä»»åŒæ­¥æºã€‚</p>
<h4 id="2stats_proxysql_servers_metrics-è¡¨">2.<strong>stats_proxysql_servers_metrics è¡¨</strong></h4>
<pre tabindex="0"><code>show create table stats.stats_proxysql_servers_metrics;
| stats_proxysql_servers_metrics | CREATE TABLE stats_proxysql_servers_metrics (
    hostname VARCHAR NOT NULL,
    port INT NOT NULL DEFAULT 6032,
    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 0,
    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
    response_time_ms INT NOT NULL,
    Uptime_s INT NOT NULL,
    last_check_ms INT NOT NULL,
    Queries INT NOT NULL,
    Client_Connections_connected INT NOT NULL,
    Client_Connections_created INT NOT NULL,
    PRIMARY KEY (hostname, port) ) |
</code></pre><p>å½“æ‰§è¡Œshow mysql statusè¯­å¥æ—¶ï¼Œæ˜¾ç¤ºä¸€äº›å·²æ£€ç´¢åˆ°çš„æŒ‡æ ‡ã€‚å­—æ®µæ„ä¹‰å¦‚ä¸‹ï¼š
- hostnameï¼šProxySQLå®ä¾‹ä¸»æœºå
- portï¼šProxySQLå®ä¾‹ç«¯å£
- weightï¼šæŠ¥å‘Šç»“æœåŒproxysql_servers.weightå­—æ®µ
- commentï¼šæŠ¥å‘Šç»“æœåŒproxysql_servers.commentå­—æ®µ
- response_time_msï¼šæ‰§è¡Œshow mysql statusçš„å“åº”æ—¶é•¿ï¼Œå•ä½æ¯«ç§’
- Uptime_sï¼šProxySQLå®ä¾‹çš„uptimeï¼Œå•ä½ç§’
- last_check_msï¼šæœ€è¿‘ä¸€æ¬¡æ‰§è¡Œcheckè·ç°åœ¨å·²å¤šä¹…ï¼Œå•ä½æ¯«ç§’
- Queriesï¼šè¯¥å®ä¾‹å·²æ‰§è¡Œqueryçš„æ•°é‡
- Client_Connections_connectedï¼šnumber of client&rsquo;s connections connected
- Client_Connections_createdï¼šnumber of client&rsquo;s connections created
**æ³¨æ„ï¼š**å½“å‰è¿™äº›çŠ¶æ€åªä¸ºdebugç›®çš„ï¼Œä½†æœªæ¥å¯èƒ½ä¼šä½œä¸ºè¿œç¨‹å®ä¾‹çš„å¥åº·æŒ‡æ ‡ã€‚</p>
<h4 id="3stats_proxysql_servers_status">3.stats_proxysql_servers_status</h4>
<p>Currently unused â€“ this table was created to show general statistics related to all the services configured in the <code>proxysql_servers</code> table.</p>
<pre tabindex="0"><code>Admin&gt; show create table stats.stats_proxysql_servers_status\G
*************************** 1. row ***************************
       table: stats_proxysql_servers_status
Create Table: CREATE TABLE stats_proxysql_servers_status (
    hostname VARCHAR NOT NULL,
    port INT NOT NULL DEFAULT 6032,
    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 0,
    master VARCHAR NOT NULL,
    global_version INT NOT NULL,
    check_age_us INT NOT NULL,
    ping_time_us INT NOT NULL, checks_OK INT NOT NULL,
    checks_ERR INT NOT NULL,
    PRIMARY KEY (hostname, port) )
1 row in set (0.00 sec)
</code></pre><h4 id="re-configuration">Re-configuration</h4>
<p>å› ä¸ºé›†ç¾¤é—´ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ç›¸äº’ç›‘æ§çš„ã€‚æ¯ä¸ªProxySQLèŠ‚ç‚¹éƒ½ç›‘æ§é›†ç¾¤ä¸­çš„å…¶å®ƒå®ä¾‹ï¼Œå®ƒä»¬å¯ä»¥å¿«é€Ÿæ¢æµ‹åˆ°æŸä¸ªå®ä¾‹çš„é…ç½®æ˜¯å¦å‘ç”Ÿæ”¹å˜ã€‚å¦‚æœæŸå®ä¾‹çš„é…ç½®å‘ç”Ÿæ”¹å˜ï¼Œå…¶å®ƒå®ä¾‹ä¼šæ£€æŸ¥è¿™ä¸ªé…ç½®å’Œè‡ªèº«çš„é…ç½®æ˜¯å¦ç›¸åŒï¼Œå› ä¸ºå…¶å®ƒèŠ‚ç‚¹çš„é…ç½®å¯èƒ½å’Œæœ¬èŠ‚ç‚¹çš„é…ç½®åŒæ—¶(æˆ–åœ¨æçŸ­æ—¶é—´å·®èŒƒå›´)å‘ç”Ÿäº†æ”¹å˜ã€‚</p>
<p>ç”±äºç›¸äº’ç›‘æ§ï¼Œæ‰€ä»¥å½“é…ç½®å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œå®ƒä»¬å¯ä»¥ç«‹å³å‘ç°ã€‚å½“å…¶ä»–èŠ‚ç‚¹çš„é…ç½®å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œæœ¬èŠ‚ç‚¹ä¼šå…ˆå»æ£€æŸ¥ä¸€æ¬¡å®ƒè‡ªèº«çš„é…ç½®ï¼Œå› ä¸ºæœ‰å¯èƒ½remote instance å’Œlocal instance åŒæ—¶å‘ç”Ÿé…ç½®å˜åŠ¨ã€‚
å¦‚æœæ¯”è¾ƒç»“æœä¸åŒï¼š
<strong>-</strong> å¦‚æœå®ƒä»¬è‡ªèº«çš„ version = 1ï¼Œå°±å»æ‰¾é›†ç¾¤å†…ä»version &gt; 1çš„èŠ‚ç‚¹å¤„æ‰¾å‡ºepochæœ€å¤§å€¼çš„èŠ‚ç‚¹ï¼Œå¹¶ä»è¯¥èŠ‚ç‚¹æ‹‰å–é…ç½®åº”ç”¨åˆ°æœ¬åœ°ï¼Œå¹¶ç«‹å³åŒæ­¥ã€‚
<strong>-</strong> å¦‚æœversion &gt;1ï¼Œ è¯¥èŠ‚ç‚¹å¼€å§‹ç»Ÿè®¡å’Œå…¶ä»–èŠ‚ç‚¹é—´çš„differ æ•°ã€‚å³å¼€å§‹å¯¹æ¢æµ‹åˆ°çš„ä¸åŒé…ç½®è¿›è¡Œè®¡æ•°ã€‚
<strong>-</strong>  å½“ differ å¤§äº cluster__name___diffs_before_sync ï¼Œ  å¹¶ä¸”cluster__name__diffs_before_sync &gt; 0ï¼Œ å°±å»æ‰¾é›†ç¾¤å†… version &gt;1ï¼Œ å¹¶ä¸”epoch  æœ€é«˜çš„èŠ‚ç‚¹ï¼Œå¹¶ç«‹å³åŒæ­¥ã€‚ä¹Ÿå°±æ˜¯è¯´å½“æ¢æµ‹åˆ°ä¸åŒé…ç½®çš„æ¬¡æ•°è¶…è¿‡cluster_name_diffs_before_syncï¼Œä¸”cluster_name_diffs_before_syncå¤§äº0æ—¶ï¼Œæ‰¾å‡ºversion &gt; 1ä¸”epochå€¼æœ€å¤§çš„èŠ‚ç‚¹ï¼Œå¹¶ä»è¯¥èŠ‚ç‚¹æ‹‰å–é…ç½®ç¦ç”¨åº”ç”¨ã€‚</p>
<p>åŒæ­¥é…ç½®çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š
<strong>-</strong> ç”¨äºå¥åº·æ£€æŸ¥çš„è¿æ¥ï¼Œä¹Ÿç”¨æ¥æ‰§è¡Œä¸€ç³»åˆ—ç±»ä¼¼äºselect _list_of_columns from runtime_moduleçš„selectè¯­å¥ã€‚ä¾‹å¦‚ï¼š</p>
<pre tabindex="0"><code>SELECT hostgroup_id, ``hostname``, port, status, weight, compression, max_connections,  max_replication_lag, use_ssl, max_latency_ms, comment FROM  runtime_mysql_servers;``SELECT writer_hostgroup, reader_hostgroup, comment FROM runtime_mysql_replication_hostgroups;
</code></pre><p>åˆ é™¤æœ¬åœ°é…ç½®ã€‚ä¾‹å¦‚ï¼š</p>
<pre tabindex="0"><code>DELETE FROM mysql_servers;DELETE FROM mysql_replication_hostgroups;
</code></pre><p><strong>-</strong> å‘æœ¬åœ°é…ç½®è¡¨ä¸­æ’å…¥å·²ä»è¿œç«¯èŠ‚ç‚¹æ£€ç´¢åˆ°çš„æ–°é…ç½®ã€‚
<strong>-</strong> åœ¨å†…éƒ¨æ‰§è¡ŒLOAD module_name TO RUNTIMEï¼šè¿™ä¼šé€’å¢ç‰ˆæœ¬å·ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„checksumã€‚
<strong>-</strong> å¦‚æœcluster_name_save_to_disk=trueï¼Œå†åœ¨å†…éƒ¨æ‰§è¡ŒSAVE module_name TO DISKã€‚</p>
<p>å‚è€ƒæ–‡æ¡£ï¼šhttps://www.cnblogs.com/kevingrace/p/10411457.html</p>
<h4 id="è¿›è¡Œé…ç½®">è¿›è¡Œé…ç½®</h4>
<p>è¦ä½¿ç”¨çš„VIPï¼š 10.241.10.3</p>
<table>
<thead>
<tr>
<th>æœºå™¨</th>
<th>è§’è‰²</th>
<th>å†…ç½‘IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>xxx.xxx.xxx.117</td>
<td>åŸæ¥æ­å»ºå¥½çš„proxysql</td>
<td>10.241.10.1</td>
</tr>
<tr>
<td>xxx.xxx.xxx.114</td>
<td>è¦æ–°æ·»åŠ ç»„å»ºé›†ç¾¤çš„proxysql</td>
<td>10.241.10.2</td>
</tr>
</tbody>
</table>
<p>å†™é…ç½®æ–‡ä»¶å’Œå®æ—¶ä¿®æ”¹éƒ½å¯ä»¥ï¼Œè®°å¾—</p>
<p><code>load *** to runtime</code>ã€<code>save *** to disk</code></p>
<p><strong>1.è§„å®šé›†ç¾¤ä¿¡æ¯ï¼ˆåœ¨117ä¸Šï¼‰</strong></p>
<pre tabindex="0"><code>ProxySQL-Admin&gt;  set  admin-admin_credentials=&#34;admin:admin;cluster_name:123456&#34;;
Query OK, 1 row affected (0.00 sec)
ProxySQL-Admin&gt;  set admin-cluster_username=&#34;cluster_name&#34;;
Query OK, 1 row affected (0.00 sec)
ProxySQL-Admin&gt;  set admin-cluster_password=&#34;123456&#34;;
Query OK, 1 row affected (0.00 sec)
ProxySQL-Admin&gt;  set admin-cluster_check_interval_ms=200;
Query OK, 1 row affected (0.01 sec)
ProxySQL-Admin&gt;  set admin-cluster_check_status_frequency=100;
Query OK, 1 row affected (0.00 sec)


ProxySQL-Admin&gt;  load admin variables to runtime;
Query OK, 0 rows affected (0.00 sec)

ProxySQL-Admin&gt;  save admin variables  to disk;
Query OK, 35 rows affected (0.01 sec)
</code></pre><p><code>select * from global_variables;</code>å¯ä»¥æŸ¥çœ‹ä¿®æ”¹ç»“æœ</p>
<p><strong>2.å†™å…¥èŠ‚ç‚¹ä¿¡æ¯</strong></p>
<pre tabindex="0"><code>ProxySQL-Admin&gt;  show create table proxysql_servers;
| table            | Create Table                                                         
| proxysql_servers | CREATE TABLE proxysql_servers (
    hostname VARCHAR NOT NULL,
    port INT NOT NULL DEFAULT 6032,
    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 0,
    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
    PRIMARY KEY (hostname, port) ) |
1 row in set (0.00 sec)
</code></pre><p>å†™å…¥èŠ‚ç‚¹</p>
<pre tabindex="0"><code>
ProxySQL-Admin&gt;  insert into proxysql_servers(hostname,port)values(&#39;xxx.xxx.xxx.114&#39;,6032);
Query OK, 1 row affected (0.00 sec)

ProxySQL-Admin&gt;  insert into proxysql_servers(hostname,port)values(&#39;xxx.xxx.xxx.117&#39;,6032);
Query OK, 1 row affected (0.00 sec)

ProxySQL-Admin&gt;  load proxysql servers to runtime;
Query OK, 0 rows affected (0.00 sec)

ProxySQL-Admin&gt;  save proxysql servers to disk;
Query OK, 0 rows affected (0.01 sec)
</code></pre><p>ä¸ºäº†ç»ƒä¹  åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹æˆ‘ä»¬ä½¿ç”¨é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œå€¼çš„æ³¨æ„çš„æ˜¯</p>
<pre tabindex="0"><code>è¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ï¼š
å¦‚æœå­˜åœ¨å¦‚æœå­˜åœ¨``&#34;proxysql.db&#34;``æ–‡ä»¶(åœ¨``/var/lib/proxysql``ç›®å½•ä¸‹)ï¼Œåˆ™ProxySQLæœåŠ¡åªæœ‰åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶æ‰ä¼šå»è¯»å–proxysql.cnfæ–‡ä»¶å¹¶è§£æï¼›åé¢å¯åŠ¨ä¼šå°±ä¸ä¼šè¯»å–proxysql.cnfæ–‡ä»¶äº†ï¼å¦‚æœæƒ³è¦è®©proxysql.cnfæ–‡ä»¶é‡Œçš„é…ç½®åœ¨é‡å¯proxysqlæœåŠ¡åç”Ÿæ•ˆ(å³æƒ³è¦è®©proxysqlé‡å¯æ—¶è¯»å–å¹¶è§£æproxysql.cnfé…ç½®æ–‡ä»¶)ï¼Œåˆ™éœ€è¦å…ˆåˆ é™¤``/var/lib/proxysql/proxysql``.dbæ•°æ®åº“æ–‡ä»¶ï¼Œç„¶åå†é‡å¯proxysqlæœåŠ¡ã€‚è¿™æ ·å°±ç›¸å½“äºåˆå§‹åŒ–å¯åŠ¨proxysqlæœåŠ¡äº†ï¼Œä¼šå†æ¬¡ç”Ÿäº§ä¸€ä¸ªçº¯å‡€çš„proxysql.dbæ•°æ®åº“æ–‡ä»¶(å¦‚æœä¹‹å‰é…ç½®äº†proxysqlç›¸å…³è·¯ç”±è§„åˆ™ç­‰ï¼Œåˆ™å°±ä¼šè¢«æŠ¹æ‰)ã€‚
</code></pre><pre tabindex="0"><code>[root@localhost ~]# cp /etc/proxysql.cnf /etc/proxysql.cnf.bak
[root@localhost ~]# vim /etc/proxysql.cnf

admin_variables=
{
        admin_credentials=&#34;admin:admin;cluster_name:123456&#34;
#       mysql_ifaces=&#34;127.0.0.1:6032;/tmp/proxysql_admin.sock&#34;
        mysql_ifaces=&#34;0.0.0.0:6032&#34;
#       refresh_interval=2000
#       debug=true
        cluster_username=&#34;cluster_name&#34;                                  
        cluster_password=&#34;123456&#34;
        cluster_check_interval_ms=2000
        cluster_check_status_frequency=1000
}
proxysql_servers =
(
        {
        hostname=&#34;xxx.xxx.xxx.114&#34;
        port=6032
        },
        {
        hostname=&#34;xxx.xxx.xxx.117&#34;
        port=6032

        }
)
</code></pre><p>æ³¨æ„é‡Œé¢çš„åœ†æ‹¬å·</p>
<pre tabindex="0"><code>[root@localhost ~]# systemctl restart proxysql
[root@localhost ~]# ll  /var/lib/proxysql/proxysql.db 
-rw------- 1 proxysql proxysql 196608 Oct 20 11:11 /var/lib/proxysql/proxysql.db
</code></pre><h4 id="è§‚å¯Ÿé›†ç¾¤çŠ¶å†µ">è§‚å¯Ÿé›†ç¾¤çŠ¶å†µ</h4>
<pre tabindex="0"><code>[root@localhost ~]# mysql -uadmin -padmin -h127.0.0.1 -P6032
MySQL [(none)]&gt; select * from stats_proxysql_servers_metrics; 
+-----------------+------+--------+---------+------------------+----------+---------------+---------+-------------------
| hostname        | port | weight | comment | response_time_ms | Uptime_s | last_check_ms | Queries | Client_Connections
+-----------------+------+--------+---------+------------------+----------+---------------+---------+-------------------
| xxx.xxx.xxx.114  | 6032 | 0      |         | 0                | 0        | 676276571     | 0       | 0                 
| xxx.xxx.xxx.117 | 6032 | 0      |         | 0                | 0        | 676276571     | 0       | 0                 
+-----------------+------+--------+---------+------------------+----------+---------------+---------+-------------------
2 rows in set (0.00 sec)

MySQL [(none)]&gt; select * from proxysql_servers;
+-----------------+------+--------+---------+
| hostname        | port | weight | comment |
+-----------------+------+--------+---------+
| xxx.xxx.xxx.114  | 6032 | 0      |         |
| xxx.xxx.xxx.117 | 6032 | 0      |         |
+-----------------+------+--------+---------+
2 rows in set (0.00 sec)

mysql&gt; select hostname,name,checksum,updated_at from stats_proxysql_servers_checksums;
+-----------------+-------------------+--------------------+------------+
| hostname        | name              | checksum           | updated_at |
+-----------------+-------------------+--------------------+------------+
| xxx.xxx.xxx.117 | admin_variables   |                    | 1603245278 |
| xxx.xxx.xxx.117 | mysql_query_rules | 0xD331FBA2DFADB529 | 1603245278 |
| xxx.xxx.xxx.117 | mysql_servers     | 0xF38804B1395AE050 | 1603245278 |
| xxx.xxx.xxx.117 | mysql_users       | 0xA9B3797834E823FC | 1603245278 |
| xxx.xxx.xxx.117 | mysql_variables   |                    | 1603245278 |
| xxx.xxx.xxx.117 | proxysql_servers  | 0x66124755F5959C8D | 1603245278 |
| xxx.xxx.xxx.114 | admin_variables   |                    | 1603245278 |
| xxx.xxx.xxx.114 | mysql_query_rules | 0xD331FBA2DFADB529 | 1603245278 |
| xxx.xxx.xxx.114 | mysql_servers     | 0xF38804B1395AE050 | 1603245278 |
| xxx.xxx.xxx.114 | mysql_users       | 0xA9B3797834E823FC | 1603245278 |
| xxx.xxx.xxx.114 | mysql_variables   |                    | 1603245278 |
| xxx.xxx.xxx.114 | proxysql_servers  | 0x66124755F5959C8D | 1603245278 |

12 rows in set (0.00 sec)
</code></pre><p>æ­¤åå¤šçœ‹æ—¥å¿— <code>tail -f /var/lib/proxysql/proxysql.log</code>, è¿™é‡Œä¼šæç¤ºä½ éœ€è¦åšå“ªäº›æ“ä½œæˆ–æ˜¯ä¿®æ”¹å˜é‡æ¥è¿›è¡ŒåŒæ­¥ã€‚æ³¨æ„proxysql è´¦å·å’Œmonitorè´¦å·åœ¨mysqlæœºå™¨ä¸Šæ˜¯å¦æœ‰é™åˆ¶ã€‚</p>
<p>é€šè¿‡è°ƒè¯•ä½¿å¾—proxysql.logæ— æŠ¥é”™åã€‚</p>
<p>é€šè¿‡<code>select * from mysql_servers;</code>è§‚å¯Ÿæ•°æ®æ—¶å€™åŒæ­¥</p>
<p>ä¸‹é¢è¿›è¡Œé«˜å¯ç”¨é…ç½®ã€‚</p>
<h4 id="proxysqlçš„é«˜å¯ç”¨">Proxysqlçš„é«˜å¯ç”¨</h4>
<p>ä½¿ç”¨keepalived,</p>
<h3 id="keepalived-å®˜æ–¹ç½‘ç«™-httpswwwkeepalivedorg">Keepalived å®˜æ–¹ç½‘ç«™ <a href="https://www.keepalived.org/">https://www.keepalived.org/</a></h3>
<p>åŸºäºï¼ˆVitual Router Redundancy Protocolï¼Œè™šæ‹Ÿè·¯ç”±å†—ä½™åè®®ï¼‰,VRRPæ˜¯ä¸ºäº†è§£å†³é™æ€è·¯ç”±çš„é«˜å¯ç”¨ã€‚VRRPçš„åŸºæœ¬æ¶æ„ã€‚åˆ©ç”¨VIPèµ„æºæ¼‚ç§»æ¥å®ç°ProxySQLåŒèŠ‚ç‚¹çš„æ— æ„ŸçŸ¥æ•…éšœåˆ‡æ¢ï¼Œå³å¯¹å¤–æä¾›ä¸€ä¸ªç»Ÿä¸€çš„vipåœ°å€ï¼Œå¹¶ä¸”åœ¨keepalived.confæ–‡ä»¶ä¸­é…ç½®proxysqlæœåŠ¡çš„ç›‘æ§è„šæœ¬ï¼Œå½“å®•æœºæˆ–proxysqlæœåŠ¡æŒ‚æ‰æ—¶å°±å°†vipèµ„æºæ¼‚ç§»åˆ°å¦ä¸€ä¸ªæ­£å¸¸çš„èŠ‚ç‚¹ä¸Šï¼Œä»è€Œä½¿proxysqlçš„ä»£ç†å±‚æŒç»­æ— æ„Ÿåº”åœ°æä¾›æœåŠ¡ã€‚</p>
<h4 id="vrrpçš„åŸºæœ¬æ¶æ„">VRRPçš„åŸºæœ¬æ¶æ„</h4>
<p>è™šæ‹Ÿè·¯ç”±å™¨ç”±å¤šä¸ªè·¯ç”±å™¨ç»„æˆï¼Œæ¯ä¸ªè·¯ç”±å™¨éƒ½æœ‰å„è‡ªçš„IPå’Œå…±åŒçš„VRID(0-255)ï¼Œå…¶ä¸­ä¸€ä¸ªVRRPè·¯ç”±å™¨é€šè¿‡ç«é€‰æˆä¸ºMASTERï¼Œå æœ‰VIPï¼Œå¯¹å¤–æä¾›è·¯ç”±æœåŠ¡ï¼Œå…¶ä»–æˆä¸ºBACKUPï¼ŒMASTERä»¥IPç»„æ’­ï¼ˆç»„æ’­åœ°å€ï¼š224.0.0.18ï¼‰å½¢å¼å‘é€VRRPåè®®åŒ…ï¼Œä¸BACKUPä¿æŒå¿ƒè·³è¿æ¥ï¼Œè‹¥MASTERä¸å¯ç”¨ï¼ˆæˆ–BACKUPæ¥æ”¶ä¸åˆ°VRRPåè®®åŒ…ï¼‰ï¼Œåˆ™BACKUPé€šè¿‡ç«é€‰äº§ç”Ÿæ–°çš„MASTERå¹¶ç»§ç»­å¯¹å¤–æä¾›è·¯ç”±æœåŠ¡ï¼Œä»è€Œå®ç°é«˜å¯ç”¨ã€‚
é“¾æ¥ï¼šhttps://www.jianshu.com/p/b050d8861fc1</p>
<h4 id="å·¥ä½œç±»å‹">å·¥ä½œç±»å‹</h4>
<pre tabindex="0"><code class="language-undefined" data-lang="undefined">æŠ¢å å¼ï¼šå½“å‡ºç°æ¯”ç°æœ‰ä¸»æœåŠ¡å™¨ä¼˜å…ˆçº§é«˜çš„æœåŠ¡å™¨æ—¶ï¼Œä¼šå‘é€é€šå‘ŠæŠ¢å è§’è‰²æˆä¸ºä¸»æœåŠ¡å™¨
éæŠ¢å å¼ï¼š
</code></pre><p>æ ¸å¿ƒç»„ä»¶</p>
<pre tabindex="0"><code>        vrrp stackï¼švrrpåè®®çš„å®ç°
        ipvs wrapperï¼šä¸ºé›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹ç”ŸæˆIPVSè§„åˆ™
        checkersï¼šå¯¹IPVSé›†ç¾¤çš„å„RSåšå¥åº·çŠ¶æ€æ£€æµ‹
        æ§åˆ¶ç»„ä»¶ï¼šé…ç½®æ–‡ä»¶åˆ†æå™¨ï¼Œç”¨æ¥å®ç°é…ç½®æ–‡ä»¶çš„åˆ†æå’ŒåŠ è½½
        IOå¤ç”¨å™¨
        å†…å­˜ç®¡ç†ç»„ä»¶ï¼Œç”¨æ¥ç®¡ç†keepalivedé«˜å¯ç”¨æ˜¯çš„å†…å­˜ç®¡ç†
</code></pre><p><strong>æ³¨æ„ï¼šå„èŠ‚ç‚¹æ—¶é—´éœ€è¦åŒæ­¥</strong></p>
<h5 id="ä¸‹è½½å’Œå®‰è£…">ä¸‹è½½å’Œå®‰è£…</h5>
<pre tabindex="0"><code> wget https://www.keepalived.org/software/keepalived-2.1.5.tar.gz
 tar -xvf keepalived-2.1.5.tar.gz 
 cd keepalived-2.1.5
 ./configure --prefix=/usr/local/keepalived
 yum -y install openssl
 make &amp;&amp; make install
</code></pre><h5 id="åŸºæœ¬é…ç½®">åŸºæœ¬é…ç½®</h5>
<pre tabindex="0"><code># tree -l /usr/local/keepalived/etc
-- keepalived
|   |-- keepalived.conf
|   `-- samples #è¿™ä¸ªé‡Œé¢æ˜¯ä¾‹å­ï¼Œå…ˆä¸ç®¡ä»–
`-- sysconfig
    `-- keepalived
# mkdir /etc/keepalived
#  cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf
# cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/keepalived
# chkconfig keepalived on
# service keepalived start   #å¯åŠ¨æœåŠ¡
# service keepalived stop    #åœæ­¢æœåŠ¡
# service keepalived restart #é‡å¯æœåŠ¡
</code></pre><p>ä½¿ç”¨<code>service keepalived start</code>å‘½ä»¤å¯åŠ¨æœåŠ¡æ—¶ï¼Œé»˜è®¤ä¼šå°†<code>/etc/sysconfig/keepalived</code>æ–‡ä»¶ä¸­<code>KEEPALIVED_OPTIONS</code>å‚æ•°ä½œä¸º<code>keepalived</code>æœåŠ¡å¯åŠ¨æ—¶çš„å‚æ•°ï¼Œå¹¶ä»<code>/etc/keepalived/</code>ç›®å½•ä¸‹åŠ è½½keepalived.confé…ç½®æ–‡ä»¶ï¼Œæˆ–ç”¨-få‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚</p>
<h5 id="è¿›è¡Œé…ç½®æ–‡ä»¶çš„ä¹¦å†™">è¿›è¡Œé…ç½®æ–‡ä»¶çš„ä¹¦å†™</h5>
<p>117 ä½œä¸ºmsater</p>
<pre tabindex="0"><code>! Configuration File for keepalived

global_defs {
   script_user root
   enable_script_security 
   router_id Master-proxysql #æ ‡è¯†æœ¬èŠ‚ç‚¹çš„åç§°ï¼Œé€šå¸¸ä¸ºhostname
}
## keepalivedä¼šå®šæ—¶æ‰§è¡Œè„šæœ¬å¹¶å¯¹è„šæœ¬æ‰§è¡Œçš„ç»“æœè¿›è¡Œåˆ†æ,åŠ¨æ€è°ƒæ•´vrrp_instanceçš„ä¼˜å…ˆçº§ã€‚
##å¦‚æœè„šæœ¬æ‰§è¡Œç»“æœä¸º0,å¹¶ä¸”weighté…ç½®çš„å€¼å¤§äº0,åˆ™ä¼˜å…ˆçº§ç›¸åº”çš„å¢åŠ ã€‚å¦‚æœè„šæœ¬æ‰§è¡Œç»“æœé0,
##å¹¶ä¸”weighté…ç½®çš„å€¼å°äº 0,åˆ™ä¼˜å…ˆçº§ç›¸åº”çš„å‡å°‘ã€‚å…¶ä»–æƒ…å†µ,ç»´æŒåŸæœ¬é…ç½®çš„ä¼˜å…ˆçº§,å³é…ç½®æ–‡ä»¶ä¸­priorityå¯¹åº”çš„å€¼ã€‚
vrrp_script chk_proxysql {
	script &#34;/etc/keepalived/sql_check.sh&#34;
	interval 2 #æ¯2ç§’æ£€æµ‹ä¸€æ¬¡nginxçš„è¿è¡ŒçŠ¶æ€
	weight -20 #å¤±è´¥ä¸€æ¬¡ï¼Œå°†è‡ªå·±çš„ä¼˜å…ˆçº§-20
}
vrrp_instance VI_1 {
    state MASTER  # çŠ¶æ€ï¼Œä¸»èŠ‚ç‚¹ä¸ºMASTERï¼Œå¤‡ä»½èŠ‚ç‚¹ä¸ºBACKUP
    interface eth1  # ç»‘å®šVIPçš„ç½‘ç»œæ¥å£ï¼Œé€šè¿‡ip aæŸ¥çœ‹è‡ªå·±çš„ç½‘ç»œæ¥å£
    virtual_router_id 123 # è™šæ‹Ÿè·¯ç”±çš„IDå·,ä¸¤ä¸ªèŠ‚ç‚¹è®¾ç½®å¿…é¡»ä¸€æ ·,å¯é€‰IPæœ€åä¸€æ®µä½¿ç”¨,ç›¸åŒçš„VRIDä¸ºä¸€ä¸ªç»„,ä»–å°†å†³å®šå¤šæ’­çš„MACåœ°å€
    mcast_src_ip 10.241.10.1  # æœ¬æœºIPåœ°å€
    priority 110 # èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼Œå€¼èŒƒå›´0ï½254ï¼ŒMASTERè¦æ¯”BACKUPé«˜
    advert_int 1  # ç»„æ’­ä¿¡æ¯å‘é€æ—¶é—´é—´éš”ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»è®¾ç½®ä¸€æ ·ï¼Œé»˜è®¤ä¸º1ç§’
    # è®¾ç½®éªŒè¯ä¿¡æ¯ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸€è‡´
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    # è™šæ‹ŸIPï¼Œä¸¤ä¸ªèŠ‚ç‚¹è®¾ç½®å¿…é¡»ä¸€æ ·ã€‚å¯ä»¥è®¾ç½®å¤šä¸ªï¼Œä¸€è¡Œå†™ä¸€ä¸ª
    virtual_ipaddress {
    	10.241.10.3
	}
    track_script {
		chk_proxysql	# nginxå­˜æ´»çŠ¶æ€æ£€æµ‹è„šæœ¬		
	}
}
</code></pre><p>114ä¸ºBACKUP</p>
<pre tabindex="0"><code>! Configuration File for keepalived

global_defs {
   script_user root
   enable_script_security 
   router_id Master-proxysql
}

vrrp_script chk_proxysql {
	script &#34;/etc/keepalived/sql_check.sh&#34;
	interval 2
	weight -20
}
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 123
    mcast_src_ip 10.241.10.2
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
    	10.241.10.3
	}
    track_script {
	chk_proxysql			
	}
}
</code></pre><p>æ£€æŸ¥proxysqlçš„è„šæœ¬ <code>cat /etc/keepalived/sql_check.sh</code></p>
<pre tabindex="0"><code>#!/bin/bash
echo &#39;æˆ‘å¼€å§‹è¿è¡Œå•¦&#39;
num=`ps aux | grep   proxysql | grep -cv grep`
echo â€˜è®°å½•å¥½äº†â€™ $num
if [ $num -eq 0 ];then
        #è¿™é‡Œå¿½ç•¥é‡å¯
	echo &#39;è¿›å…¥åˆ¤æ–­&#39;
        sleep 1
        if [ `ps aux | grep   proxysql | grep -cv grep` -eq 0 ];then
                echo &#39;è¿›å…¥å°åˆ¤æ–­&#39;
		echo &#39;stop keepalived&#39; &gt; /etc/keepalived/chk_log
		kill -9 $(ps aux | grep keepalived | grep -v grep | cut  -d&#39; &#39; -f 7)
		echo &#39;stop !&#39; &gt; /etc/keepalived/chk_log
        fi
fi
</code></pre><p><strong>è®°å¾—ç»™è„šæœ¬æ‰§è¡Œæƒé™</strong><code>chmod a+x /etc/keepalived/proxysql_check.sh </code></p>
<p>å¯åŠ¨keepalivedå<code>ip a</code>æŸ¥çœ‹</p>
<p>keepalived-masterç«¯</p>
<pre tabindex="0"><code>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:50:56:ab:d7:be brd ff:ff:ff:ff:ff:ff
    inet 10.241.10.1/16 brd 10.241.255.255 scope global eth1
       valid_lft forever preferred_lft forever
    inet 10.241.10.3/32 scope global eth1
       valid_lft forever preferred_lft forever
    inet6 fe80::250:56ff:feab:d7be/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre><p>keepalived-slaveç«¯</p>
<pre tabindex="0"><code>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:50:56:ab:4a:16 brd ff:ff:ff:ff:ff:ff
    inet 10.241.10.2/16 brd 10.241.255.255 scope global eth1
       valid_lft forever preferred_lft forever
    inet6 fe80::250:56ff:feab:4a16/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre><h3 id="æ£€æŸ¥">æ£€æŸ¥</h3>
<p>ã€å°†ä¸»æœºproxysqlå…³é—­ï¼Œä¼šå‘ç°ä¸»æœºä¸Šçš„keepalivedå…³é—­ï¼Œ<code>vip:10.241.10.3</code> é£˜ç§»åˆ°äº†ä»æœºå™¨ã€‘</p>
<p>ä½¿ç”¨é£˜ç§»VIPè¿æ¥MYSQL</p>
<p>åœ¨è¯»å†™æœŸé—´è¿›è¡Œä»æœºåˆ‡æ¢æ–°å»º<code>test</code>æ•°æ®åº“ <code>test</code>æ•°æ®è¡¨</p>
<pre tabindex="0"><code>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| dbtest             |
| hanzhongtest       |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
6 rows in set (0.00 sec)
mysql&gt; create database proxysqlHA;
Query OK, 1 row affected (0.01 sec)
mysql&gt; use proxysqlHA;
Database changed
mysql&gt; create table test_id(id int,name varchar(10));
Query OK, 0 rows affected (0.01 sec)
</code></pre><p>åœ¨pythonå†™å…¥æ—¶ï¼Œè¿›è¡Œåˆ‡æ¢</p>
<pre tabindex="0"><code>import pymysql
config = {
&#39;host&#39; : &#39;10.241.10.3&#39;,
&#39;db&#39; : &#39;proxysqlHA&#39;,
&#39;user&#39; : &#39;proxysql&#39;,
&#39;password&#39; : &#39;Proxy-123456&#39;,
&#39;port&#39; : 6033,
}
for i in range(1,1000000):
insertstr = &#34;insert into test_id values(%s,&#39;zhangsan%s&#39;)&#34; % (i,str(i),i)
print(insertstr)
sqlstr = insertstr
db = pymysql.connect(**config)
cursor = db.cursor()
cursor.execute(sqlstr)
db.commit()
print(&#34;count: {}&#34;.format(i) )
db.close()
</code></pre><p>åœ¨å¼€å§‹å†™å…¥åå…³é—­117ä¸»æœºçš„proxysqlï¼Œè§‚å¯Ÿå‘ç°ç¡®å®åœ¨åˆ‡æ¢è¿‡ç¨‹çš„ä¸€ç¬é—´ä¼šå‡ºç°å†™å…¥å¤±è´¥ã€‚åˆ‡æ¢å®Œæˆåè®¿é—®æ­£å¸¸ã€‚</p>
<h3 id="é‡åˆ°çš„é—®é¢˜-1">é‡åˆ°çš„é—®é¢˜</h3>
<p>1.å¿˜è®°å°†æ£€æŸ¥è„šæœ¬å¼„æˆæ‰§è¡Œæƒé™</p>
<p>2.è„šæœ¬çš„åå­—å®Œå…¨åŒ…å«äº†proxysql å¯¼è‡´æ£€æŸ¥å‡ºé”™ã€‚</p>
<p>3.åˆ‡æ¢æ—¶é—´åŒ…æ‹¬ keepalivedè¿è¡Œè„šæœ¬çš„é—´éš”æ—¶é—´ã€æ£€æŸ¥è„šæœ¬çš„sleepæ—¶é—´ã€ç»„æ’­ä¿¡æ¯é—´éš”çš„æ—¶é—´ã€‚æƒ³è¦æœ€å°åŒ–æ—¶é—´éœ€è¦å°†æ‰€æœ‰é—´éš”å’Œsleepå‡å»ã€‚</p>
<p>ä½†æ˜¯ç»„æ’­ä¿¡æ¯é—´éš”æ—¶é—´<code>vrrp version 2</code> ä¸­æœ€å°åªèƒ½åˆ°1s é»˜è®¤å¯åŠ¨<code>vrrp version 2</code></p>
<hr>

        </article>
    </div>

    
       	






<div id="comments" class="post-comments">
  <div class="comment-head">
    <div class="comment-headline">
      <i class="fa fa-comments fa-fw"></i>
      
    </div>
  
  </div>
  <div class="comment-wrap">
  
  
    <div>      
      <div class="comment-loading">
    <i class="fa fa-sync fa-spin"></i>
  </div>
      <div class="waline-container"></div>

    </div>
  
  </div>
</div>  

    
</div><aside class="Qc_aside">

<section class="Qc_aside_item tags"> 
    <div class="Qc_aside_item-title"> 
        <i class="iconfont icon-A67" style="margin-right: 8px;font-size: 17px"></i> 
        <span class="text">æ–‡ç« åˆ†ç±»</span> 
        <span class="qccq_mac"></span> 
    </div> 
    <div class="Qc_aside_item-contain" style="padding:10px"> 
        <div class="tag"></div> 
		<ul class="list">
			
			
			   
			<li class="item"> 
				<a class="link" href="/categories/%E4%B8%93%E4%B8%9A%E6%8A%80%E8%83%BD/">ä¸“ä¸šæŠ€èƒ½ </a>
				<span class="widget__counter widget__counter--bubble">3</span>
			</li>
			
			   
			<li class="item"> 
				<a class="link" href="/categories/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/">ä¸ªäººéšç¬” </a>
				<span class="widget__counter widget__counter--bubble">1</span>
			</li>
	</div>
</section>




<section class="Qc_aside_item tags"> 
    <div class="Qc_aside_item-title"> 
        <i class="iconfont icon-A67" style="margin-right: 8px;font-size: 17px"></i> 
        <span class="text">æ ‡ç­¾äº‘</span> 
        <span class="xccx_mac"></span> 
    </div> 
     <div class="Qc_aside_item-contain" style="padding:10px"> 
        <div class="tag"></div> 
        <ul class="cloud">
            

                
            <li class="item">
                <a style="background:#4C83FF" href="/tags/anisble/" title="Anisble">Anisble</a>
            </li>

                
            <li class="item">
                <a style="background:#4C83FF" href="/tags/etcd/" title="ETCD">ETCD</a>
            </li>

                
            <li class="item">
                <a style="background:#4C83FF" href="/tags/proxysql/" title="ProxySQL">ProxySQL</a>
            </li>
         </ul> 
        </div> 
    </section>



    

    <section class="sticky_layout"><style>

    .card-widget:first-child {
        margin-top: 0
    }

    @media screen and (max-width:900px) {
        .card-widget:first-child {
            margin-top: 20px
        }
    }

     .card-widget {
        position: relative;
        overflow: hidden;
        margin-top: 20px;
        padding: 20px 24px;
        color:var(--main)
    }

     .card-widget,
    #recent-posts>.recent-post-item,
    .cardHover,
    .error404 #error-wrap .error-content,
    .layout>.recent-posts .pagination>:not(.space),
    .layout>div:first-child:not(.recent-posts) {
        border-radius: 8px;
        background: var(--background);
        -webkit-box-shadow: var(--card-box-shadow);
        box-shadow: var(--card-box-shadow);
        -webkit-transition: all .3s;
        -moz-transition: all .3s;
        -o-transition: all .3s;
        -ms-transition: all .3s;
        transition: all .3s
    }

    .card-widget:hover,
    #recent-posts>.recent-post-item:hover,
    .cardHover:hover,
    .error404 #error-wrap .error-content:hover,
    .layout>.recent-posts .pagination>:not(.space):hover,
    .layout>div:first-child:not(.recent-posts):hover {
        -webkit-box-shadow: var(--card-hover-box-shadow);
        box-shadow: var(--card-hover-box-shadow)
    }



    .item-headline {
        padding-bottom: 6px;
        font-size: 1.2em
    }

     .item-headline span {
        margin-left: 6px
    }

   
 
     @media screen and (min-width:900px) {
        .sticky_layout {
            position: sticky;
            position: -webkit-sticky;
            top: 60px;
            -webkit-transition: top .3s;
            -moz-transition: top .3s;
            -o-transition: top .3s;
            -ms-transition: top .3s;
            transition: top .3s
        }
    } 

    



    #card-toc .toc-percentage {
        float: right;
        margin-top: -9px;
        color: #a9a9a9;
        font-style: italic;
        font-size: 140%
    }

    #card-toc .toc-content {
        overflow-y: scroll;
        overflow-y: overlay;
        margin: 0 -24px;
        max-height: calc(100vh - 120px)
    }

    @media screen and (max-width:900px) {
         #card-toc .toc-content {
            max-height: calc(100vh - 140px)
        }
    }

     #card-toc .toc-content>* {
        margin: 0 20px !important
    }



     #card-toc .toc-content>*>.toc-item>.toc-child {
        margin-left: 10px;
        padding-left: 10px;
        border-left: 1px solid var(--dark-grey)
    }

    #card-toc .toc-content:not(.is-expand) .toc-child {
        display: none
    }

    @media screen and (max-width:900px) {
        #card-toc .toc-content:not(.is-expand) .toc-child {
            display: block !important
        }
    }

   #card-toc .toc-content:not(.is-expand) .toc-item.active .toc-child {
        display: block
    }

    #card-toc .toc-content li,
     #card-toc .toc-content ol {
        list-style: none
    }

     #card-toc .toc-content>ol {
        padding: 0 !important
    }

    #card-toc .toc-content ol {
        margin: 0;
        padding-left: 18px
    }

    #card-toc .toc-content .toc-link {
        display: block;
        margin: 4px 0;
        padding: 1px 6px;
        color: var(--toc-link-color);
        -webkit-transition: all .2s ease-in-out;
        -moz-transition: all .2s ease-in-out;
        -o-transition: all .2s ease-in-out;
        -ms-transition: all .2s ease-in-out;
        transition: all .2s ease-in-out
    }

     #card-toc .toc-content .toc-link:hover {
        color: #49b1f5
    }

    #card-toc .toc-content .toc-link.active {
        background: #00c4b6;
        color: #fff
    }

     .sticky_layout:only-child>:first-child {
        margin-top: 20px
    }


</style><div class="card-widget" id="card-toc">
        <div class="item-headline">
            <i class="fa fa-bars"></i>
            <span>ç›®å½•</span>
            <span class="toc-percentage">0</span>
        </div>
        <div class="toc-content"><ol class="toc">
                        <li class="toc-item toc-level-3">
                            <a class="toc-link" href="#proxysql" aria-label="ProxySQL" data-pjax-state="anchor">
                                <span class="toc-number">1</span> 
                                <span class="toc-text">ProxySQL</span>
                            </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e4%b8%8b%e8%bd%bd%e4%b8%8e%e5%ae%89%e8%a3%85" aria-label="ä¸‹è½½ä¸å®‰è£…" data-pjax-state="anchor">
                            <span class="toc-number">2</span> 
                            <span class="toc-text">ä¸‹è½½ä¸å®‰è£…</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#ubuntu" aria-label="Ubuntu" data-pjax-state="anchor">
                            <span class="toc-number">3</span> 
                            <span class="toc-text">Ubuntu</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e4%b8%8b%e8%bd%bd" aria-label="ä¸‹è½½" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">ä¸‹è½½</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e5%ae%89%e8%a3%85" aria-label="å®‰è£…" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">å®‰è£…</span>
                        </a></li></ol>
                        </li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#centos8" aria-label="Centos8" data-pjax-state="anchor">
                            <span class="toc-number">3</span> 
                            <span class="toc-text">Centos8</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e4%b8%8b%e8%bd%bd-1" aria-label="ä¸‹è½½" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">ä¸‹è½½</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e5%ae%89%e8%a3%85-1" aria-label="å®‰è£…" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">å®‰è£…</span>
                        </a></li></ol>
                        </li></ol>
                        </li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e5%90%af%e5%8a%a8" aria-label="å¯åŠ¨" data-pjax-state="anchor">
                            <span class="toc-number">2</span> 
                            <span class="toc-text">å¯åŠ¨</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e7%99%bb%e5%bd%95" aria-label="ç™»å½•" data-pjax-state="anchor">
                            <span class="toc-number">2</span> 
                            <span class="toc-text">ç™»å½•</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e5%a4%9a%e5%b1%82%e7%9a%84%e9%85%8d%e7%bd%ae%e7%b3%bb%e7%bb%9f" aria-label="å¤šå±‚çš„é…ç½®ç³»ç»Ÿ" data-pjax-state="anchor">
                            <span class="toc-number">2</span> 
                            <span class="toc-text">å¤šå±‚çš„é…ç½®ç³»ç»Ÿ</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e9%85%8d%e7%bd%ae%e4%b8%bb%e4%bb%8e%e5%88%86%e7%bb%84%e4%bf%a1%e6%81%af" aria-label="é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯" data-pjax-state="anchor">
                            <span class="toc-number">2</span> 
                            <span class="toc-text">é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e5%b0%86%e4%b8%aa%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%b7%bb%e5%8a%a0%e5%88%b0mysql_server%e8%a1%a8" aria-label="å°†ä¸ªæœåŠ¡å™¨æ·»åŠ åˆ°mysql_serverè¡¨" data-pjax-state="anchor">
                            <span class="toc-number">2</span> 
                            <span class="toc-text">å°†ä¸ªæœåŠ¡å™¨æ·»åŠ åˆ°mysql_serverè¡¨</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#proxysql-%e7%9b%91%e6%8e%a7%e5%90%8e%e7%ab%af%e8%8a%82%e7%82%b9" aria-label="ProxySQL ç›‘æ§åç«¯èŠ‚ç‚¹" data-pjax-state="anchor">
                            <span class="toc-number">2</span> 
                            <span class="toc-text">ProxySQL ç›‘æ§åç«¯èŠ‚ç‚¹</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e9%85%8d%e7%bd%aeproxy" aria-label="é…ç½®proxy" data-pjax-state="anchor">
                            <span class="toc-number">2</span> 
                            <span class="toc-text">é…ç½®proxy</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e9%85%8d%e7%bd%ae%e8%af%bb%e5%86%99%e5%88%86%e7%a6%bb" aria-label="é…ç½®è¯»å†™åˆ†ç¦»" data-pjax-state="anchor">
                            <span class="toc-number">3</span> 
                            <span class="toc-text">é…ç½®è¯»å†™åˆ†ç¦»</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e8%b7%af%e7%94%b1%e8%a7%84%e5%88%99" aria-label="è·¯ç”±è§„åˆ™" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">è·¯ç”±è§„åˆ™</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e8%a7%84%e5%88%99%e7%9a%84%e5%86%99%e5%85%a5" aria-label="è§„åˆ™çš„å†™å…¥" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">è§„åˆ™çš„å†™å…¥</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e8%af%bb%e5%86%99%e5%88%86%e7%a6%bb%e6%b5%8b%e8%af%95" aria-label="è¯»å†™åˆ†ç¦»æµ‹è¯•" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">è¯»å†™åˆ†ç¦»æµ‹è¯•</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e6%b5%8b%e8%af%95%e8%af%bb" aria-label="æµ‹è¯•è¯»" data-pjax-state="anchor">
                            <span class="toc-number">5</span> 
                            <span class="toc-text">æµ‹è¯•è¯»</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e6%b5%8b%e8%af%95%e5%86%99" aria-label="æµ‹è¯•å†™" data-pjax-state="anchor">
                            <span class="toc-number">5</span> 
                            <span class="toc-text">æµ‹è¯•å†™</span>
                        </a></li></ol>
                        </li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e6%9f%a5%e7%9c%8b%e8%b7%af%e7%94%b1%e4%bf%a1%e6%81%af" aria-label="æŸ¥çœ‹è·¯ç”±ä¿¡æ¯" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">æŸ¥çœ‹è·¯ç”±ä¿¡æ¯</span>
                        </a></li></ol>
                        </li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“ï¼š" data-pjax-state="anchor">
                            <span class="toc-number">3</span> 
                            <span class="toc-text">æ€»ç»“ï¼š</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="é‡åˆ°çš„é—®é¢˜" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">é‡åˆ°çš„é—®é¢˜</span>
                        </a></li></ol>
                        </li></ol>
                        </li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#proxysql-%e7%9a%84%e9%ab%98%e5%8f%af%e7%94%a8" aria-label="ProxySql çš„é«˜å¯ç”¨" data-pjax-state="anchor">
                            <span class="toc-number">2</span> 
                            <span class="toc-text">ProxySql çš„é«˜å¯ç”¨</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e7%9b%b8%e5%85%b3%e5%8f%98%e9%87%8f" aria-label="ç›¸å…³å˜é‡" data-pjax-state="anchor">
                            <span class="toc-number">3</span> 
                            <span class="toc-text">ç›¸å…³å˜é‡</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#1%e7%94%a8%e4%ba%8e%e5%90%8c%e6%ad%a5%e7%9a%84%e5%8f%98%e9%87%8f" aria-label="1.ç”¨äºåŒæ­¥çš„å˜é‡" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">1.ç”¨äºåŒæ­¥çš„å˜é‡</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#2%e9%9b%86%e7%be%a4%e5%87%ad%e8%af%81%e5%8f%98%e9%87%8f" aria-label="2.é›†ç¾¤å‡­è¯å˜é‡" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">2.é›†ç¾¤å‡­è¯å˜é‡</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#3%e6%a3%80%e6%9f%a5%e9%a2%91%e7%8e%87%e5%92%8c%e9%97%b4%e9%9a%94%e6%97%b6%e9%97%b4" aria-label="3.æ£€æŸ¥é¢‘ç‡å’Œé—´éš”æ—¶é—´" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">3.æ£€æŸ¥é¢‘ç‡å’Œé—´éš”æ—¶é—´</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#4%e5%b0%86%e9%85%8d%e7%bd%ae%e5%90%8c%e6%ad%a5%e5%88%b0%e7%a3%81%e7%9b%98" aria-label="4.å°†é…ç½®åŒæ­¥åˆ°ç£ç›˜" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">4.å°†é…ç½®åŒæ­¥åˆ°ç£ç›˜</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#5%e6%98%af%e5%90%a6%e9%9c%80%e8%a6%81%e8%bf%9c%e7%a8%8b%e5%90%8c%e6%ad%a5%e5%8f%98%e9%87%8f" aria-label="5.æ˜¯å¦éœ€è¦è¿œç¨‹åŒæ­¥å˜é‡" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">5.æ˜¯å¦éœ€è¦è¿œç¨‹åŒæ­¥å˜é‡</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#6%e5%bb%b6%e8%bf%9f%e5%90%8c%e6%ad%a5" aria-label="6.å»¶è¿ŸåŒæ­¥" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">6.å»¶è¿ŸåŒæ­¥</span>
                        </a></li></ol>
                        </li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e9%9c%80%e8%a6%81%e9%85%8d%e7%bd%ae%e7%9a%84%e8%a1%a8" aria-label="éœ€è¦é…ç½®çš„è¡¨" data-pjax-state="anchor">
                            <span class="toc-number">3</span> 
                            <span class="toc-text">éœ€è¦é…ç½®çš„è¡¨</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#1proxysql_servers" aria-label="1.proxysql_servers" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">1.proxysql_servers</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#2runtime_proxysql_servers" aria-label="2.runtime_proxysql_servers" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">2.runtime_proxysql_servers</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#3runtime_checksums_values" aria-label="3.runtime_checksums_values" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">3.runtime_checksums_values</span>
                        </a></li></ol>
                        </li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#stats-tables" aria-label="stats tables" data-pjax-state="anchor">
                            <span class="toc-number">3</span> 
                            <span class="toc-text">stats tables</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#1stats_proxysql_servers_checksums" aria-label="1.stats_proxysql_servers_checksums" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">1.stats_proxysql_servers_checksums</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#2stats_proxysql_servers_metrics-%e8%a1%a8" aria-label="2.stats_proxysql_servers_metrics è¡¨" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">2.<strong>stats_proxysql_servers_metrics è¡¨</strong></span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#3stats_proxysql_servers_status" aria-label="3.stats_proxysql_servers_status" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">3.stats_proxysql_servers_status</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#re-configuration" aria-label="Re-configuration" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">Re-configuration</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e8%bf%9b%e8%a1%8c%e9%85%8d%e7%bd%ae" aria-label="è¿›è¡Œé…ç½®" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">è¿›è¡Œé…ç½®</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e8%a7%82%e5%af%9f%e9%9b%86%e7%be%a4%e7%8a%b6%e5%86%b5" aria-label="è§‚å¯Ÿé›†ç¾¤çŠ¶å†µ" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">è§‚å¯Ÿé›†ç¾¤çŠ¶å†µ</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#proxysql%e7%9a%84%e9%ab%98%e5%8f%af%e7%94%a8" aria-label="Proxysqlçš„é«˜å¯ç”¨" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">Proxysqlçš„é«˜å¯ç”¨</span>
                        </a></li></ol>
                        </li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#keepalived-%e5%ae%98%e6%96%b9%e7%bd%91%e7%ab%99-httpswwwkeepalivedorg" aria-label="Keepalived å®˜æ–¹ç½‘ç«™ https://www.keepalived.org/" data-pjax-state="anchor">
                            <span class="toc-number">3</span> 
                            <span class="toc-text">Keepalived å®˜æ–¹ç½‘ç«™ <a href="https://www.keepalived.org/">https://www.keepalived.org/</a></span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#vrrp%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%9e%b6%e6%9e%84" aria-label="VRRPçš„åŸºæœ¬æ¶æ„" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">VRRPçš„åŸºæœ¬æ¶æ„</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e5%b7%a5%e4%bd%9c%e7%b1%bb%e5%9e%8b" aria-label="å·¥ä½œç±»å‹" data-pjax-state="anchor">
                            <span class="toc-number">4</span> 
                            <span class="toc-text">å·¥ä½œç±»å‹</span>
                        </a><ol class="toc-child">

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e4%b8%8b%e8%bd%bd%e5%92%8c%e5%ae%89%e8%a3%85" aria-label="ä¸‹è½½å’Œå®‰è£…" data-pjax-state="anchor">
                            <span class="toc-number">5</span> 
                            <span class="toc-text">ä¸‹è½½å’Œå®‰è£…</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e5%9f%ba%e6%9c%ac%e9%85%8d%e7%bd%ae" aria-label="åŸºæœ¬é…ç½®" data-pjax-state="anchor">
                            <span class="toc-number">5</span> 
                            <span class="toc-text">åŸºæœ¬é…ç½®</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e8%bf%9b%e8%a1%8c%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%9a%84%e4%b9%a6%e5%86%99" aria-label="è¿›è¡Œé…ç½®æ–‡ä»¶çš„ä¹¦å†™" data-pjax-state="anchor">
                            <span class="toc-number">5</span> 
                            <span class="toc-text">è¿›è¡Œé…ç½®æ–‡ä»¶çš„ä¹¦å†™</span>
                        </a></li></ol>
                        </li></ol>
                        </li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e6%a3%80%e6%9f%a5" aria-label="æ£€æŸ¥" data-pjax-state="anchor">
                            <span class="toc-number">3</span> 
                            <span class="toc-text">æ£€æŸ¥</span>
                        </a></li>

                    <li class="toc-item toc-level-2">
                        <a class="toc-link" href="#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98-1" aria-label="é‡åˆ°çš„é—®é¢˜" data-pjax-state="anchor">
                            <span class="toc-number">3</span> 
                            <span class="toc-text">é‡åˆ°çš„é—®é¢˜</span>
                        </a>
                    </li>
                </ol>
                </li>
                </ol>
                </li>
            </ol>

        </div>
    </div>





<script>

    const btf = {
    
        scrollToDest: (pos, time = 500) => {
            const currentPos = window.pageYOffset
            if (currentPos > pos) pos = pos - 70
        
            if ('scrollBehavior' in document.documentElement.style) {
                window.scrollTo({
                top: pos,
                behavior: 'smooth'
                })
                return
            }
        
            let start = null
            pos = +pos
            window.requestAnimationFrame(function step (currentTime) {
                start = !start ? currentTime : start
                const progress = currentTime - start
                if (currentPos < pos) {
                window.scrollTo(0, ((pos - currentPos) * progress / time) + currentPos)
                } else {
                window.scrollTo(0, currentPos - ((currentPos - pos) * progress / time))
                }
                if (progress < time) {
                window.requestAnimationFrame(step)
                } else {
                window.scrollTo(0, pos)
                }
            })
        },
    
       
        getEleTop: ele => {
            let actualTop = ele.offsetTop
            let current = ele.offsetParent
        
            while (current !== null) {
                actualTop += current.offsetTop
                current = current.offsetParent
            }
        
            return actualTop
        },

        updateAnchor: (anchor) => {
            if (anchor !== window.location.hash) {
                if (!anchor) anchor = location.pathname
                const title = "ç§‹ç è®°å½•"
                window.history.replaceState({
                    url: location.href,
                    title
                }, title, anchor)
            }
        },


        throttle: function (func, wait, options) {
            let timeout, context, args
            let previous = 0
            if (!options) options = {}
        
            const later = function () {
                previous = options.leading === false ? 0 : new Date().getTime()
                timeout = null
                func.apply(context, args)
                if (!timeout) context = args = null
            }
        
            const throttled = function () {
                const now = new Date().getTime()
                if (!previous && options.leading === false) previous = now
                
                const remaining = wait - (now - previous)
                context = this
                args = arguments
                if (remaining <= 0 || remaining > wait) {
                    if (timeout) {
                        clearTimeout(timeout)
                        timeout = null
                    }
                    previous = now
                    func.apply(context, args)
                    if (!timeout) context = args = null
                } else if (!timeout && options.trailing !== false) {
                    timeout = setTimeout(later, remaining)
                }
            }
        
            return throttled
        },

        getScrollPercent: (currentTop, ele) => {
            const docHeight = ele.clientHeight
            const winHeight = document.documentElement.clientHeight
            const headerHeight = ele.offsetTop
            const contentMath = (docHeight > winHeight) ? (docHeight - winHeight) : (document.documentElement.scrollHeight - winHeight)
            const scrollPercent = (currentTop - headerHeight) / (contentMath)
            const scrollPercentRounded = Math.round(scrollPercent * 100)
            const percentage = (scrollPercentRounded > 100) ? 100 : (scrollPercentRounded <= 0) ? 0 : scrollPercentRounded
            return percentage
        },




    }  



     

    const scrollFnToDo = function () {
      const isToc = true 
      const isAnchor = true 
      const $article = document.getElementById('article-container')
  
      if (!($article && (isToc || isAnchor))) return
  
      let $tocLink, $cardToc, autoScrollToc, $tocPercentage, isExpand
  
      if (isToc) {
        const $cardTocLayout = document.getElementById('card-toc')
        $cardToc = $cardTocLayout.getElementsByClassName('toc-content')[0]
        $tocLink = $cardToc.querySelectorAll('.toc-link')
        $tocPercentage = $cardTocLayout.querySelector('.toc-percentage')
        isExpand = $cardToc.classList.contains('is-expand')
  
        window.mobileToc = {
          open: () => {
            $cardTocLayout.style.cssText = 'animation: toc-open .3s; opacity: 1; right: 55px'
          },
  
          close: () => {
            $cardTocLayout.style.animation = 'toc-close .2s'
            setTimeout(() => {
              $cardTocLayout.style.cssText = "opacity:''; animation: ''; right: ''"
            }, 100)
          }
        }
  
        
        $cardToc.addEventListener('click', e => {
          e.preventDefault()
          const target = e.target.classList
          if (target.contains('toc-content')) return
          const $target = target.contains('toc-link')
            ? e.target
            : e.target.parentElement
          btf.scrollToDest(btf.getEleTop(document.getElementById(decodeURI($target.getAttribute('href')).replace('#', ''))), 300)
          if (window.innerWidth < 900) {
            window.mobileToc.close()
          }
        })
  
        autoScrollToc = item => {
          const activePosition = item.getBoundingClientRect().top
          const sidebarScrollTop = $cardToc.scrollTop
          if (activePosition > (document.documentElement.clientHeight - 100)) {
            $cardToc.scrollTop = sidebarScrollTop + 150
          }
          if (activePosition < 100) {
            $cardToc.scrollTop = sidebarScrollTop - 150
          }
        }
      }
  
      
      const list = $article.querySelectorAll('h1,h2,h3,h4,h5,h6')
      let detectItem = ''
      const findHeadPosition = function (top) {
        if (top === 0) {
          return false
        }
  
        let currentId = ''
        let currentIndex = ''
  
        list.forEach(function (ele, index) {
          if (top > btf.getEleTop(ele) - 80) {
            const id = ele.id
            currentId = id ? '#' + encodeURI(id) : ''
            currentIndex = index
          }
        })
  
        if (detectItem === currentIndex) return
  
        if (isAnchor) btf.updateAnchor(currentId)
  
        detectItem = currentIndex
  
        if (isToc) {
          $cardToc.querySelectorAll('.active').forEach(i => { i.classList.remove('active') })
  
          if (currentId === '') {
            return
          }
  
          const currentActive = $tocLink[currentIndex]
          currentActive.classList.add('active')
  
          setTimeout(() => {
            autoScrollToc(currentActive)
          }, 0)
  
          if (isExpand) return
          let parent = currentActive.parentNode
  
          for (; !parent.matches('.toc'); parent = parent.parentNode) {
            if (parent.matches('li')) parent.classList.add('active')
          }
        }
      }
  
      
      window.tocScrollFn = btf.throttle(() => {
        const currentTop = window.scrollY || document.documentElement.scrollTop
        
         if(isToc){
          $tocPercentage.textContent = btf.getScrollPercent(currentTop, $article)
        }
        findHeadPosition(currentTop)
      }, 100)
  
      window.addEventListener('scroll', tocScrollFn)
    }
  

    scrollFnToDo()
</script>





    </section>
     

</aside></div>
	<footer class="Qc_footer">
		<div class="Qc_container">
			<div class="item">
				<p>2018 - 2023 ç‰ˆæƒæ‰€æœ‰ Â©<a href="http://beian.miit.gov.cn/">é—½ICPå¤‡2021005633å·-2</a></p>
			</div>

			<div class="item">
				<p>
					<strong>æœ¬ç«™ç”± <span style="color:blue;font:bold;">Hugo</span> é©±åŠ¨çš„ 
						<a href="https://github.com/zhenqicai/hugo-theme-kiwi" target="_blank" >hugo-theme-kiwi V0.0.1</a> ä¸»é¢˜å¼ºåŠ›æ”¯æ’‘</strong>
				</p>
			</div>
		
		</div>
		</div>
	</footer>

	<style>
		.joe_action {
			position: fixed;
			bottom: 90px;
			right: 30px;
			z-index: 333;
		}


		.joe_action_item.scroll.active {
			visibility: visible;
			-webkit-transform: scale(1);
			transform: scale(1);
		}

		.joe_action_item.scroll {
			visibility: hidden;
			-webkit-transform: scale(0);
			transform: scale(0);
			transition: visibility 0.35s, -webkit-transform 0.35s;
			transition: visibility 0.35s, transform 0.35s;
			transition: visibility 0.35s, transform 0.35s, -webkit-transform 0.35s;
		}

		.joe_action_item {
			box-shadow: rgb(0 0 0 / 10%) 0px 0px 10px, rgb(0 0 0 / 20%) 0px 5px 20px;
			background: var(--darkreader-bg--background);
		}
		.joe_action_item {
			position: relative;
			display: flex;
			align-items: center;
			justify-content: center;
			width: 40px;
			height: 40px;
			background: var(--background);
			border-radius: 50%;
			cursor: pointer;
			margin-top: 15px;
			box-shadow: 0 0 10px rgb(0 0 0 / 10%), 0 5px 20px rgb(0 0 0 / 20%);
		}
		.joe_action_item svg {
			position: absolute;
			width: 25px;
			height: 25px;
			fill: var(--theme);
		}



		.joe_action_item.mode svg{-webkit-transform:scale(0);transform:scale(0);opacity:0}
		.joe_action_item.mode svg.active{-webkit-transform:scale(1);transform:scale(1);opacity:1}
		
	</style>


	<div class="joe_action">
		<div class="joe_action_item scroll ">
			<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="25" height="25">
				<path d="M725.902 498.916c18.205-251.45-93.298-410.738-205.369-475.592l-6.257-3.982-6.258 3.414c-111.502 64.853-224.711 224.142-204.8 475.59-55.751 53.476-80.214 116.623-80.214 204.8v15.36l179.2-35.27c11.378 40.39 58.596 69.973 113.21 69.973 54.613 0 101.262-29.582 112.64-68.836l180.337 36.41v-15.36c-.569-89.885-25.031-153.6-82.489-206.507zM571.733 392.533c-33.564 31.29-87.04 28.445-118.329-5.12s-28.444-87.04 5.12-117.76c33.565-31.289 87.04-28.444 118.33 5.12s28.444 86.471-5.12 117.76zm-56.32 368.64c-35.84 0-64.284 29.014-64.284 64.285 0 35.84 54.044 182.613 64.284 182.613s64.285-146.773 64.285-182.613c0-35.271-29.014-64.285-64.285-64.285z"></path>
			</svg>
		</div>
		<div class="joe_action_item mode">
			<svg class="icon-1 " viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="25" height="25">
				<path d="M587.264 104.96c33.28 57.856 52.224 124.928 52.224 196.608 0 218.112-176.128 394.752-393.728 394.752-29.696 0-58.368-3.584-86.528-9.728C223.744 832.512 369.152 934.4 538.624 934.4c229.376 0 414.72-186.368 414.72-416.256 1.024-212.992-159.744-389.12-366.08-413.184z"></path>
				<path d="M340.48 567.808l-23.552-70.144-70.144-23.552 70.144-23.552 23.552-70.144 23.552 70.144 70.144 23.552-70.144 23.552-23.552 70.144zM168.96 361.472l-30.208-91.136-91.648-30.208 91.136-30.208 30.72-91.648 30.208 91.136 91.136 30.208-91.136 30.208-30.208 91.648z"></path>
			</svg>
			<svg class="icon-2 active" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="25" height="25">
				<path d="M234.24 512a277.76 277.76 0 1 0 555.52 0 277.76 277.76 0 1 0-555.52 0zM512 187.733a42.667 42.667 0 0 1-42.667-42.666v-102.4a42.667 42.667 0 0 1 85.334 0v102.826A42.667 42.667 0 0 1 512 187.733zm-258.987 107.52a42.667 42.667 0 0 1-29.866-12.373l-72.96-73.387a42.667 42.667 0 0 1 59.306-59.306l73.387 72.96a42.667 42.667 0 0 1 0 59.733 42.667 42.667 0 0 1-29.867 12.373zm-107.52 259.414H42.667a42.667 42.667 0 0 1 0-85.334h102.826a42.667 42.667 0 0 1 0 85.334zm34.134 331.946a42.667 42.667 0 0 1-29.44-72.106l72.96-73.387a42.667 42.667 0 0 1 59.733 59.733l-73.387 73.387a42.667 42.667 0 0 1-29.866 12.373zM512 1024a42.667 42.667 0 0 1-42.667-42.667V878.507a42.667 42.667 0 0 1 85.334 0v102.826A42.667 42.667 0 0 1 512 1024zm332.373-137.387a42.667 42.667 0 0 1-29.866-12.373l-73.387-73.387a42.667 42.667 0 0 1 0-59.733 42.667 42.667 0 0 1 59.733 0l72.96 73.387a42.667 42.667 0 0 1-29.44 72.106zm136.96-331.946H878.507a42.667 42.667 0 1 1 0-85.334h102.826a42.667 42.667 0 0 1 0 85.334zM770.987 295.253a42.667 42.667 0 0 1-29.867-12.373 42.667 42.667 0 0 1 0-59.733l73.387-72.96a42.667 42.667 0 1 1 59.306 59.306l-72.96 73.387a42.667 42.667 0 0 1-29.866 12.373z"></path>
			</svg>
		</div>
	</div>

	

	

	
	<script src="https://hanzhongzi.github.io/js/highlight.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

   

   <script>
	 function registerImageLoadEvent() {
		const images = document.querySelectorAll('.sidebar img, .Qc_post img, .vendors-list img');
				
		const callback = (entries) => {
			entries.forEach(item => {
				if (item.intersectionRatio > 0) {
					let ele = item.target;
					let imgSrc = ele.getAttribute('src');
					ele.setAttribute("src","1.png")
					ele.setAttribute("data-lazy-src",imgSrc)
					ele.classList.add("lazyload")
			
				}
			})
		};

		Array.from(images).forEach(img => {
			const bg = '/images/loading.gif'

			img.setAttribute("data-lazy-src",img.src)
			img.src = bg
		})
		
	
	}

	registerImageLoadEvent()

   </script>


 <script src="https://hanzhongzi.github.io/js/lazyload.life.min.js"></script>

 <script>
	const lazyloadImg = () => {
      window.lazyLoadInstance = new LazyLoad({
        elements_selector: 'img',
        threshold: 0,
        data_src: 'lazy-src'
      })
    }

	lazyloadImg()
 </script>


	</div>
</body>



</html>



<script>
	
	var mybutton = document.querySelector(".joe_action .joe_action_item.scroll")
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            
            
			mybutton.classList.add("active")
        } else {
            
            
			mybutton.classList.remove("active")
        }
    };

	mybutton.addEventListener("click",() => {
		document.documentElement.scrollTop = document.body.scrollTop = 0;
	})
	


</script>



<script>
	var themeBtn = document.querySelector(".joe_action .joe_action_item.mode")
	let icon_1 = document.querySelector(".joe_action .joe_action_item.mode .icon-1")
	let icon_2 = document.querySelector(".joe_action .joe_action_item.mode .icon-2")
    themeBtn.addEventListener("click", () => {
		
        if (icon_1.classList.contains("active")) {
            icon_1.classList.remove('active');
			icon_2.classList.add('active');
			document.querySelector("html").removeAttribute("data-night")
            localStorage.setItem("pref-theme", 'light');
        } else {
			icon_2.classList.remove('active');
			icon_1.classList.add('active');
			document.querySelector("html").setAttribute("data-night","night")
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
